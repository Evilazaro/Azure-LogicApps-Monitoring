@page "/orders"
@rendermode InteractiveWebAssembly
@using eShop.Orders.App.Client.Models
@using eShop.Orders.App.Client.Services
@using System.ComponentModel.DataAnnotations
@inject OrderService OrderService
@inject ILogger<Orders> Logger

<PageTitle>Orders - eShop</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Order Management</h1>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Place New Order</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@_currentOrder" OnValidSubmit="@HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger" />

                        <div class="mb-3">
                            <label for="orderId" class="form-label">Order ID</label>
                            <InputText id="orderId" 
                                       class="form-control" 
                                       @bind-Value="_currentOrder.Id"
                                       placeholder="Enter unique order ID" />
                            <ValidationMessage For="@(() => _currentOrder.Id)" />
                        </div>

                        <div class="mb-3">
                            <label for="orderDate" class="form-label">Order Date</label>
                            <InputDate id="orderDate" 
                                       class="form-control" 
                                       @bind-Value="_currentOrder.Date" />
                            <ValidationMessage For="@(() => _currentOrder.Date)" />
                        </div>

                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <InputNumber id="quantity" 
                                         class="form-control" 
                                         @bind-Value="_currentOrder.Quantity"
                                         placeholder="Enter quantity (min: 1)" />
                            <ValidationMessage For="@(() => _currentOrder.Quantity)" />
                        </div>

                        <div class="mb-3">
                            <label for="total" class="form-label">Total Amount ($)</label>
                            <InputNumber id="total" 
                                         class="form-control" 
                                         @bind-Value="_currentOrder.Total"
                                         placeholder="Enter total amount" />
                            <ValidationMessage For="@(() => _currentOrder.Total)" />
                        </div>

                        <div class="mb-3">
                            <label for="message" class="form-label">Order Message</label>
                            <InputTextArea id="message" 
                                           class="form-control" 
                                           rows="3"
                                           @bind-Value="_currentOrder.Message"
                                           placeholder="Enter order notes or confirmation message" />
                            <ValidationMessage For="@(() => _currentOrder.Message)" />
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" 
                                    class="btn btn-primary btn-lg" 
                                    disabled="@_isProcessing">
                                @if (_isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>Place Order</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Order Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-5">Total Orders Placed:</span>
                        <span class="badge bg-primary fs-5">@_orderCount</span>
                    </div>
                    
                    @if (_lastOrderTotal > 0)
                    {
                        <div class="border-top pt-3">
                            <small class="text-muted">Last Order Total:</small>
                            <div class="fs-4 text-success">@_lastOrderTotal.ToString("C")</div>
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <div class="alert @GetAlertClass() mt-3" role="alert">
                    <strong>@(_isLastOperationSuccess ? "Success!" : "Error!")</strong>
                    <p class="mb-0 mt-2">@_statusMessage</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private Order _currentOrder = new()
    {
        Date = DateTime.UtcNow,
        Quantity = 1,
        Total = 0.00m,
        Message = "Thank you for your order!"
    };

    private int _orderCount = 0;
    private decimal _lastOrderTotal = 0;
    private string _statusMessage = string.Empty;
    private bool _isProcessing = false;
    private bool _isLastOperationSuccess = false;

    /// <summary>
    /// Handles validated form submission and places the order.
    /// </summary>
    private async Task HandleValidSubmit()
    {
        _isProcessing = true;
        _statusMessage = string.Empty;
        StateHasChanged();

        try
        {
            var result = await OrderService.PlaceOrderAsync(_currentOrder);

            _isLastOperationSuccess = result.IsSuccess;
            _statusMessage = result.Message;

            if (result.IsSuccess)
            {
                _orderCount++;
                _lastOrderTotal = _currentOrder.Total;
                ResetForm();
            }

            Logger.LogInformation(
                "Order submission {Status}: {Message}",
                result.IsSuccess ? "succeeded" : "failed",
                result.Message);
        }
        catch (Exception ex)
        {
            _isLastOperationSuccess = false;
            _statusMessage = $"An unexpected error occurred: {ex.Message}";
            Logger.LogError(ex, "Unexpected error during order submission");
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Resets the order form to default values.
    /// </summary>
    private void ResetForm()
    {
        _currentOrder = new Order
        {
            Id = string.Empty,
            Date = DateTime.UtcNow,
            Quantity = 1,
            Total = 0.00m,
            Message = "Thank you for your order!"
        };
    }

    /// <summary>
    /// Gets the appropriate Bootstrap alert class based on operation status.
    /// </summary>
    private string GetAlertClass() => _isLastOperationSuccess ? "alert-success" : "alert-danger";
}
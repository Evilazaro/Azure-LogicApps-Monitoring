@page "/orders"
@rendermode InteractiveWebAssembly
@using System.Net.Http.Json
@using System.Net.Http
@using Microsoft.AspNetCore.Components.WebAssembly.Http
@inject HttpClient Http

<PageTitle>Orders</PageTitle>

<h1>Orders</h1>

<p role="status">Current count: @currentCount</p>

<button class="btn btn-primary" @onclick="PlaceAnOrder">Place an Order</button>

<p></p>

<textarea rows="10" class="form-control" placeholder="Enter order details in JSON format" @bind="orderJson"></textarea>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert alert-info mt-3">@statusMessage</div>
}

@code {
    private int currentCount = 0;
    private string orderJson = string.Empty;
    private string statusMessage = string.Empty;

    private async Task<string> PlaceAnOrder()
    {
        if (string.IsNullOrWhiteSpace(orderJson))
        {
            statusMessage = "Please enter order details";
            return string.Empty;
        }

        try
        {
            // call the Orders API using ordersproxy class
            var order = new OrdersProxy(Http);
            var result = await order.CreateOrder(orderJson);

            if (result is ContentResult contentResult)
            {
                if (contentResult.StatusCode >= 200 && contentResult.StatusCode < 300)
                {
                    currentCount++;
                    statusMessage = "Order placed successfully!";
                    orderJson = string.Empty;
                }
                else
                {
                    statusMessage = $"Failed to place order: {contentResult.StatusCode} - {contentResult.Content}";
                }
            }
            else
            {
                statusMessage = $"Unexpected result type: {result.GetType().Name}";
            }
        }
        catch (HttpRequestException ex)
        {
            statusMessage = $"HTTP Error: {ex.Message}";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
        }

        return statusMessage;
    }
}
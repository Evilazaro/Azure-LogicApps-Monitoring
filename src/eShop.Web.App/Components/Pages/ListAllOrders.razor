@page "/listallorders"
@using eShop.Web.App.Components.Services;
@using app.ServiceDefaults.CommonTypes;
@using Microsoft.FluentUI.AspNetCore.Components;
@rendermode InteractiveServer
@inject OrdersService ordersService

<PageTitle>All Orders</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="20" Style="padding: 24px;">
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
        <FluentLabel Typo="Typography.H3">All Orders</FluentLabel>
        <FluentLabel Typo="Typography.Body">
            View all orders and their associated products.
        </FluentLabel>
    </FluentStack>
    
    <FluentButton Appearance="Appearance.Accent" 
                  OnClick="LoadOrdersAsync" 
                  Loading="@isLoading">
        Load Orders
    </FluentButton>

    @if (errorMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Error" Title="Error">
            @errorMessage   
        </FluentMessageBar>
    }
    else if (orders != null)
    {
        @if (!orders.Any())
        {
            <FluentMessageBar Intent="MessageIntent.Info" Title="No Data">
                No orders found in the system.
            </FluentMessageBar>
        }
        else
        {
            <FluentLabel Typo="Typography.Subject">
                @orders.Count() order@(orders.Count() == 1 ? "" : "s") found
            </FluentLabel>

            <FluentStack Orientation="Orientation.Vertical" VerticalGap="16" Style="width: 100%;">
                @foreach (var order in orders.OrderByDescending(o => o.Date))
                {
                    <FluentCard Style="width: 100%; padding: 0;">
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="0" Style="width: 100%;">
                            <!-- Order Header -->
                            <FluentStack Orientation="Orientation.Horizontal" 
                                       VerticalAlignment="VerticalAlignment.Center"
                                       Style="padding: 16px; background-color: var(--neutral-layer-1); border-bottom: 1px solid var(--neutral-stroke-rest); cursor: pointer;"
                                       @onclick="() => ToggleOrder(order.Id)">
                                <FluentStack Orientation="Orientation.Horizontal" 
                                           VerticalAlignment="VerticalAlignment.Center"
                                           HorizontalGap="12"
                                           Style="flex: 1;">
                                    <FluentLabel Style="font-size: 16px;">
                                        @(expandedOrders.Contains(order.Id) ? "▼" : "▶")
                                    </FluentLabel>
                                    
                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="min-width: 100px;">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Order ID</FluentLabel>
                                        <FluentLabel Typo="Typography.Body" Style="font-weight: 600;">@order.Id</FluentLabel>
                                    </FluentStack>

                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="min-width: 120px;">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Customer</FluentLabel>
                                        <FluentLabel Typo="Typography.Body">@order.CustomerId</FluentLabel>
                                    </FluentStack>

                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="min-width: 180px;">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Order Date</FluentLabel>
                                        <FluentLabel Typo="Typography.Body">@order.Date.ToString("yyyy-MM-dd HH:mm")</FluentLabel>
                                    </FluentStack>

                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="flex: 1;">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Delivery Address</FluentLabel>
                                        <FluentLabel Typo="Typography.Body">@order.DeliveryAddress</FluentLabel>
                                    </FluentStack>

                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4" Style="min-width: 120px; align-items: flex-end;">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Total</FluentLabel>
                                        <FluentLabel Typo="Typography.Body" Style="font-weight: 700; color: var(--accent-fill-rest);">@order.Total.ToString("C2")</FluentLabel>
                                    </FluentStack>

                                    <FluentBadge Appearance="Appearance.Neutral" Circular="true">
                                        @order.Products.Count()
                                    </FluentBadge>
                                </FluentStack>
                            </FluentStack>

                            <!-- Expandable Products Section -->
                            @if (expandedOrders.Contains(order.Id))
                            {
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="16" Style="padding: 20px; background-color: var(--neutral-layer-2);">
                                    <FluentLabel Typo="Typography.Body" Style="font-weight: 600;">Products (@order.Products.Count())</FluentLabel>
                                    
                                    @if (order.Products.Any())
                                    {
                                        <FluentDataGrid Items="@order.Products.AsQueryable()" 
                                                       GridTemplateColumns="100px 2fr 100px 120px 120px"
                                                       Style="width: 100%; background-color: var(--neutral-layer-1); border: 1px solid var(--neutral-stroke-rest);">
                                            <PropertyColumn Property="@(p => p.ProductId)" 
                                                           Title="Product ID" 
                                                           Align="Align.Start" />
                                            <PropertyColumn Property="@(p => p.ProductDescription)" 
                                                           Title="Description" 
                                                           Align="Align.Start" />
                                            <PropertyColumn Property="@(p => p.Quantity)" 
                                                           Title="Quantity" 
                                                           Align="Align.Center" />
                                            <PropertyColumn Property="@(p => p.Price)" 
                                                           Title="Unit Price" 
                                                           Format="C2" 
                                                           Align="Align.End" />
                                            <TemplateColumn Title="Subtotal" Align="Align.End" Context="product">
                                                <strong>@((product.Quantity * product.Price).ToString("C2"))</strong>
                                            </TemplateColumn>
                                        </FluentDataGrid>
                                        
                                        <FluentDivider Style="width: 100%;" />
                                        
                                        <FluentStack Orientation="Orientation.Horizontal" 
                                                    HorizontalAlignment="HorizontalAlignment.End"
                                                    HorizontalGap="12">
                                            <FluentLabel Typo="Typography.Body" Style="font-weight: 600;">
                                                Order Total:
                                            </FluentLabel>
                                            <FluentLabel Typo="Typography.Body" Style="font-weight: 700; font-size: 18px; color: var(--accent-fill-rest);">
                                                @order.Total.ToString("C2")
                                            </FluentLabel>
                                        </FluentStack>
                                    }
                                    else
                                    {
                                        <FluentMessageBar Intent="MessageIntent.Warning">
                                            No products in this order.
                                        </FluentMessageBar>
                                    }
                                </FluentStack>
                            }
                        </FluentStack>
                    </FluentCard>
                }
            </FluentStack>
        }
    }
</FluentStack>

@code {
    private bool isLoading = false;
    private string? errorMessage;
    private IEnumerable<Order>? orders;
    private HashSet<string> expandedOrders = new();

    private async Task LoadOrdersAsync()
    {
        isLoading = true;
        errorMessage = null;
        orders = null;
        expandedOrders.Clear();

        try
        {
            orders = await ordersService.GetOrdersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleOrder(string orderId)
    {
        if (expandedOrders.Contains(orderId))
        {
            expandedOrders.Remove(orderId);
        }
        else
        {
            expandedOrders.Add(orderId);
        }
    }
}


@page "/vieworder"
@page "/vieworder/{OrderId}"
@using eShop.Web.App.Components.Services
@using eShop.Web.App.Components.Shared
@using eShop.Web.App.Shared
@using app.ServiceDefaults.CommonTypes
@using Microsoft.FluentUI.AspNetCore.Components
@rendermode InteractiveServer
@inject OrdersService ordersService
@inject NavigationManager navigationManager

<PageTitle>View Order</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="@(int.Parse(FluentDesignSystem.Spacing.Large))" Class="page-container">
    <PageHeader Title="View Order" Description="Search and view order details by Order ID." />
    
    <!-- Search Section -->
    <FluentStack Orientation="Orientation.Horizontal" VerticalGap="@(int.Parse(FluentDesignSystem.Spacing.Medium))" HorizontalGap="@(int.Parse(FluentDesignSystem.Spacing.Medium))" Style="align-items: flex-end;">
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="@(int.Parse(FluentDesignSystem.Spacing.Small))" Style="flex: 1; max-width: 400px;">
            <FieldLabel Label="Order ID" IsBold="true" FontSize="@FluentDesignSystem.FontSizes.Body" />
            <FluentTextField @bind-Value="searchOrderId" 
                           Placeholder="Enter Order ID"
                           Aria-Label="Order ID Search"
                           Style="width: 100%;"
                           @onkeydown="HandleKeyDown"
                           Disabled="@isLoading" />
        </FluentStack>
        
        <FluentButton Appearance="Appearance.Accent" 
                      OnClick="SearchOrderAsync" 
                      Loading="@isLoading"
                      Aria-Label="Search for order"
                      Style="width: fit-content;">
            Search Order
        </FluentButton>
    </FluentStack>

    @if (errorMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Error" Title="Error" 
                         Style="animation: fadeIn 0.3s ease-in-out;">
            @errorMessage   
        </FluentMessageBar>
    }
    else if (orderNotFound)
    {
        <FluentMessageBar Intent="MessageIntent.Warning" Title="Not Found"
                         Style="animation: fadeIn 0.3s ease-in-out;">
            Order with ID "<strong>@searchOrderId</strong>" was not found in the system.
        </FluentMessageBar>
    }
    else if (isLoading && string.IsNullOrEmpty(searchOrderId) == false)
    {
        <LoadingCard Message="Searching for order..." />
    }
    else if (order != null)
    {
        <!-- Order Details Card -->
        <FluentCard Style="width: 100%; padding: 0; margin-top: 8px; animation: slideUp 0.4s ease-in-out;">
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="0" Style="width: 100%;">
                <!-- Order Header -->
                <FluentStack Orientation="Orientation.Vertical" 
                           VerticalGap="@(int.Parse(FluentDesignSystem.Spacing.Medium))"
                           Style="@GetOrderHeaderStyle()">
                    <FluentLabel Typo="Typography.H5" Style="color: var(--accent-fill-rest);">Order Details</FluentLabel>
                    
                    <div class="responsive-grid">
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body" class="field-label-small">Order ID</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Style="@GetSemiBoldLargeStyle()">
                                @order.Id
                            </FluentLabel>
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body" class="field-label-small">Customer ID</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Style="@GetLargeFontStyle()">
                                @order.CustomerId
                            </FluentLabel>
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body" class="field-label-small">Order Date</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Style="@GetLargeFontStyle()">
                                <time datetime="@order.Date.ToString("yyyy-MM-ddTHH:mm:ss")">
                                    @order.Date.ToString("yyyy-MM-dd HH:mm:ss")
                                </time>
                            </FluentLabel>
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body" class="field-label-small">Delivery Address</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Style="font-size: 1.125rem;">
                                @order.DeliveryAddress
                            </FluentLabel>
                        </FluentStack>

                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body" class="field-label-small">Order Total</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Style="@GetOrderTotalStyle()">
                                @order.Total.ToString("C2")
                            </FluentLabel>
                        </FluentStack>
                    </div>
                </FluentStack>

                <!-- Products Section -->
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="@(int.Parse(FluentDesignSystem.Spacing.Medium))" Style="@( $"padding: {FluentDesignSystem.Padding.Medium}; background-color: var(--neutral-layer-2);" )">
                    <FluentLabel Typo="Typography.Body" class="section-header">
                        Products (@order.Products.Count())
                    </FluentLabel>
                    
                    @if (order.Products.Any())
                    {
                        <FluentDataGrid Items="@order.Products.AsQueryable()" 
    GridTemplateColumns="@FluentDesignSystem.DataGridColumns.ProductsGrid"
    Style=@($"width: 100%; background-color: var(--neutral-layer-1); border: 1px solid var(--neutral-stroke-rest); font-size: {FluentDesignSystem.FontSizes.Body};")>
                            <PropertyColumn Property="@(p => p.ProductId)" 
                                           Title="Product ID" 
                                           Align="Align.Start" />
                            <PropertyColumn Property="@(p => p.ProductDescription)" 
                                           Title="Description" 
                                           Align="Align.Start"
                                           Class="description-column" />
                            <PropertyColumn Property="@(p => p.Quantity)" 
                                           Title="Qty" 
                                           Align="Align.Center" />
                            <PropertyColumn Property="@(p => p.Price)" 
                                           Title="Unit Price" 
                                           Format="C2" 
                                           Align="Align.End" />
                            <TemplateColumn Title="Subtotal" Align="Align.End" Context="product">
                                <strong>@((product.Quantity * product.Price).ToString("C2"))</strong>
                            </TemplateColumn>
                        </FluentDataGrid>
                        
                        <FluentDivider Style="width: 100%; margin: 4px 0;" Role="DividerRole.Separator" />
                        
                        <FluentStack Orientation="Orientation.Horizontal" 
                                    HorizontalAlignment="HorizontalAlignment.End"
                                    HorizontalGap="@(int.Parse(FluentDesignSystem.Spacing.Medium))"
                                    Style="padding-right: 4px;">
                            <FluentLabel Typo="Typography.Body" Style="@($"font-weight: {FluentDesignSystem.FontWeights.SemiBold}; font-size: {FluentDesignSystem.FontSizes.Subtitle};")">
                                Order Total:
                            </FluentLabel>
                            <FluentLabel Typo="Typography.Body" Style="@GetOrderTotalBottomStyle()">
                                @order.Total.ToString("C2")
                            </FluentLabel>
                        </FluentStack>
                    }
                    else
                    {
                        <FluentMessageBar Intent="MessageIntent.Warning">
                            No products in this order.
                        </FluentMessageBar>
                    }
                </FluentStack>
            </FluentStack>
        </FluentCard>
    }
</FluentStack>

<style>
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    [Parameter]
    public string? OrderId { get; set; }

    private bool isLoading = false;
    private string? errorMessage;
    private bool orderNotFound = false;
    private Order? order;
    private string searchOrderId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrWhiteSpace(OrderId))
        {
            searchOrderId = OrderId;
            await SearchOrderAsync();
        }
    }

    private async Task SearchOrderAsync()
    {
        if (string.IsNullOrWhiteSpace(searchOrderId))
        {
            errorMessage = "Please enter an Order ID";
            return;
        }

        isLoading = true;
        errorMessage = null;
        orderNotFound = false;
        order = null;

        try
        {
            order = await ordersService.GetOrderByIdAsync(searchOrderId);
            
            if (order == null)
            {
                orderNotFound = true;
            }
            else
            {
                navigationManager.NavigateTo($"/vieworder/{searchOrderId}", replace: true);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await SearchOrderAsync();
        }
    }

    private string GetOrderTotalStyle()
    {
        return $"font-weight: {FluentDesignSystem.FontWeights.Bold}; font-size: {FluentDesignSystem.FontSizes.LargeTitle}; color: var(--accent-fill-rest);";
    }

    private string GetOrderTotalBottomStyle()
    {
        return $"font-weight: {FluentDesignSystem.FontWeights.Bold}; font-size: {FluentDesignSystem.FontSizes.LargeTitle}; color: var(--accent-fill-rest);";
    }

    private string GetOrderHeaderStyle()
    {
        return $"padding: {FluentDesignSystem.Padding.Medium}; background-color: var(--neutral-layer-1);";
    }

    private string GetSemiBoldLargeStyle()
    {
        return $"font-weight: {FluentDesignSystem.FontWeights.SemiBold}; font-size: {FluentDesignSystem.FontSizes.LargeTitle};";
    }

    private string GetLargeFontStyle()
    {
        return $"font-size: {FluentDesignSystem.FontSizes.LargeTitle};";
    }
}
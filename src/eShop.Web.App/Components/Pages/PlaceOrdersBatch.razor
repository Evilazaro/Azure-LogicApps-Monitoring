@page "/placeordersbatch"
@using eShop.Web.App.Components.Services;
@using app.ServiceDefaults.CommonTypes;
@using Microsoft.FluentUI.AspNetCore.Components;
@using System.Text.Json;
@using System.Text.Json.Serialization;
@rendermode InteractiveServer
@inject OrdersAPIService ordersService

<PageTitle>Place Orders in Batch</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="16"
    Style="padding: 20px; max-width: 1400px; margin: 0 auto;">
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="6">
        <FluentLabel Typo="Typography.H4">Place Orders in Batch</FluentLabel>
        <FluentLabel Typo="Typography.Body" Style="font-size: 14px; color: var(--neutral-foreground-hint);">
            Upload multiple orders at once using JSON format or add them manually.
        </FluentLabel>
    </FluentStack>

    @if (successMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Success" Title="Success">
            @successMessage
        </FluentMessageBar>
    }

    @if (errorMessage != null)
    {
        <FluentMessageBar Intent="MessageIntent.Error" Title="Error">
            @errorMessage
        </FluentMessageBar>
    }

    <!-- Input Method Tabs -->
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12">
            <FluentButton Appearance="@(inputMethod == InputMethod.Manual ? Appearance.Accent : Appearance.Outline)"
                OnClick="() => inputMethod = InputMethod.Manual" Style="width: fit-content;">
                Manual Entry
            </FluentButton>
            <FluentButton Appearance="@(inputMethod == InputMethod.Json ? Appearance.Accent : Appearance.Outline)"
                OnClick="() => inputMethod = InputMethod.Json" Style="width: fit-content;">
                JSON Import
            </FluentButton>
        </FluentStack>

        @if (inputMethod == InputMethod.Json)
        {
            <!-- JSON Input Method -->
            <FluentCard Style="width: 100%; padding: 24px;">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                        <FluentLabel Typo="Typography.Body" Style="font-weight: 600; font-size: 14px;">JSON Input
                        </FluentLabel>
                        <FluentLabel Typo="Typography.Body" Style="font-size: 13px; color: var(--neutral-foreground-hint);">
                            Paste your JSON array of orders below. Supports both PascalCase and camelCase property names.
                        </FluentLabel>
                    </FluentStack>

                    <FluentTextArea @bind-Value="jsonInput" Rows="15" Placeholder="@jsonPlaceholder"
                        Style="width: 100%; font-family: 'Courier New', monospace; font-size: 12px;" />

                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12"
                        HorizontalAlignment="HorizontalAlignment.End">
                        <FluentButton Appearance="Appearance.Neutral" OnClick="ClearJson" Style="width: fit-content;">
                            Clear
                        </FluentButton>
                        <FluentButton Appearance="Appearance.Accent" OnClick="ParseJsonAndSubmit" Loading="@isLoading"
                            Disabled="@(string.IsNullOrWhiteSpace(jsonInput))"
                            Style="width: fit-content;">
                            Parse & Submit Orders
                        </FluentButton>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        }
        else
        {
            <!-- Manual Input Method -->
            <FluentCard Style="width: 100%; padding: 24px;">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween"
                        VerticalAlignment="VerticalAlignment.Center">
                        <FluentLabel Typo="Typography.Body" Style="font-weight: 600; font-size: 15px;">Orders
                            (@batchOrders.Count)</FluentLabel>
                        <FluentButton Appearance="Appearance.Outline" OnClick="AddOrderToBatch" Style="width: fit-content;">
                            + Add Order
                        </FluentButton>
                    </FluentStack>

                    @if (!batchOrders.Any())
                    {
                        <FluentMessageBar Intent="MessageIntent.Info">
                            No orders added yet. Click "Add Order" to begin creating your batch.
                        </FluentMessageBar>
                    }
                    else
                    {
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                            @foreach (var (order, orderIndex) in batchOrders.Select((o, i) => (o, i)))
                            {
                                <FluentCard Style="padding: 20px; background-color: var(--neutral-layer-2);">
                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                                        <!-- Order Header -->
                                        <FluentStack Orientation="Orientation.Horizontal"
                                            HorizontalAlignment="HorizontalAlignment.SpaceBetween"
                                            VerticalAlignment="VerticalAlignment.Center">
                                            <FluentLabel Typo="Typography.Body"
                                                Style="font-weight: 600; font-size: 14px; color: var(--accent-fill-rest);">Order
                                                @(orderIndex + 1)</FluentLabel>
                                            <FluentButton Appearance="Appearance.Lightweight"
                                                OnClick="() => RemoveOrderFromBatch(orderIndex)" Style="color: var(--error);">
                                                Remove Order
                                            </FluentButton>
                                        </FluentStack>

                                        <!-- Order Fields -->
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12" Wrap="true">
                                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="6"
                                                Style="flex: 1; min-width: 150px;">
                                                <FluentLabel Typo="Typography.Body" Style="font-size: 12px;">Order ID</FluentLabel>
                                                <FluentTextField @bind-Value="order.Id" Placeholder="Order ID"
                                                    Style="width: 100%;" />
                                            </FluentStack>

                                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="6"
                                                Style="flex: 1; min-width: 150px;">
                                                <FluentLabel Typo="Typography.Body" Style="font-size: 12px;">Customer ID
                                                </FluentLabel>
                                                <FluentTextField @bind-Value="order.CustomerId" Placeholder="Customer ID"
                                                    Style="width: 100%;" />
                                            </FluentStack>

                                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="6"
                                                Style="flex: 2; min-width: 250px;">
                                                <FluentLabel Typo="Typography.Body" Style="font-size: 12px;">Delivery Address
                                                </FluentLabel>
                                                <FluentTextField @bind-Value="order.DeliveryAddress" Placeholder="Delivery Address"
                                                    Style="width: 100%;" />
                                            </FluentStack>
                                        </FluentStack>

                                        <!-- Products -->
                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                            <FluentStack Orientation="Orientation.Horizontal"
                                                HorizontalAlignment="HorizontalAlignment.SpaceBetween"
                                                VerticalAlignment="VerticalAlignment.Center">
                                                <FluentLabel Typo="Typography.Body" Style="font-size: 13px; font-weight: 600;">
                                                    Products</FluentLabel>
                                                <FluentButton Appearance="Appearance.Lightweight"
                                                    OnClick="() => AddProductToOrder(orderIndex)"
                                                    Style="width: fit-content; font-size: 12px;">
                                                    + Add Product
                                                </FluentButton>
                                            </FluentStack>

                                            @if (!order.Products.Any())
                                            {
                                                <FluentLabel Typo="Typography.Body"
                                                    Style="font-size: 12px; color: var(--neutral-foreground-hint);">
                                                    No products added
                                                </FluentLabel>
                                            }
                                            else
                                            {
                                                @foreach (var (product, productIndex) in order.Products.Select((p, i) => (p, i)))
                                                {
                                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8"
                                                        VerticalAlignment="VerticalAlignment.Bottom" Wrap="true">
                                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4"
                                                            Style="width: 100px;">
                                                            <FluentLabel Typo="Typography.Body" Style="font-size: 11px;">Product ID
                                                            </FluentLabel>
                                                            <FluentTextField @bind-Value="product.ProductId"
                                                                Style="width: 100%; font-size: 12px;" />
                                                        </FluentStack>

                                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4"
                                                            Style="flex: 1; min-width: 150px;">
                                                            <FluentLabel Typo="Typography.Body" Style="font-size: 11px;">Description
                                                            </FluentLabel>
                                                            <FluentTextField @bind-Value="product.ProductDescription"
                                                                Style="width: 100%; font-size: 12px;" />
                                                        </FluentStack>

                                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4"
                                                            Style="width: 70px;">
                                                            <FluentLabel Typo="Typography.Body" Style="font-size: 11px;">Qty</FluentLabel>
                                                            <FluentNumberField @bind-Value="product.Quantity" Min="1"
                                                                Style="width: 100%; font-size: 12px;" />
                                                        </FluentStack>

                                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4"
                                                            Style="width: 100px;">
                                                            <FluentLabel Typo="Typography.Body" Style="font-size: 11px;">Price</FluentLabel>
                                                            <FluentNumberField @bind-Value="product.Price" Min="0" Step="0.01"
                                                                Style="width: 100%; font-size: 12px;" />
                                                        </FluentStack>

                                                        <FluentButton Appearance="Appearance.Lightweight"
                                                            OnClick="() => RemoveProductFromOrder(orderIndex, productIndex)"
                                                            Style="color: var(--error); font-size: 12px; padding: 4px 8px;">
                                                            Remove
                                                        </FluentButton>
                                                    </FluentStack>
                                                }

                                                <FluentLabel Typo="Typography.Body"
                                                    Style="font-size: 13px; font-weight: 600; text-align: right;">
                                                    Order Total: @CalculateOrderTotal(order).ToString("C2")
                                                </FluentLabel>
                                            }
                                        </FluentStack>
                                    </FluentStack>
                                </FluentCard>
                            }
                        </FluentStack>

                        <FluentDivider Style="width: 100%;" />

                        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween"
                            VerticalAlignment="VerticalAlignment.Center">
                            <FluentLabel Typo="Typography.Body" Style="font-weight: 700; font-size: 16px;">
                                Total Orders: @batchOrders.Count | Grand Total: @CalculateGrandTotal().ToString("C2")
                            </FluentLabel>

                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12">
                                <FluentButton Appearance="Appearance.Neutral" OnClick="ClearBatch" Style="width: fit-content;">
                                    Clear All
                                </FluentButton>
                                <FluentButton Appearance="Appearance.Accent" OnClick="SubmitBatchAsync" Loading="@isLoading"
                                    Disabled="@(!IsBatchValid())" Style="width: fit-content;">
                                    Submit Batch
                                </FluentButton>
                            </FluentStack>
                        </FluentStack>
                    }
                </FluentStack>
            </FluentCard>
        }
    </FluentStack>
</FluentStack>

@code {
    private enum InputMethod { Manual, Json }

    private bool isLoading = false;
    private string? errorMessage;
    private string? successMessage;
    private InputMethod inputMethod = InputMethod.Manual;
    private List<OrderFormModel> batchOrders = new();
    private string jsonInput = string.Empty;

    private string jsonPlaceholder = @"[
  {
    ""id"": ""ORD-0001"",
    ""customerId"": ""CUST-1288"",
    ""deliveryAddress"": ""221B Baker Street, London, UK"",
    ""products"": [
      {
        ""productId"": ""PROD-8001"",
        ""productDescription"": ""USB Microphone"",
        ""quantity"": 3,
        ""price"": 108.15
      }
    ]
  }
]";

    private class OrderFormModel
    {
        public string Id { get; set; } = string.Empty;
        public string CustomerId { get; set; } = string.Empty;
        public string DeliveryAddress { get; set; } = string.Empty;
        public List<OrderProductFormModel> Products { get; set; } = new();
    }

    private class OrderProductFormModel
    {
        public string ProductId { get; set; } = string.Empty;
        public string ProductDescription { get; set; } = string.Empty;
        public int Quantity { get; set; } = 1;
        public decimal Price { get; set; } = 0;
    }

    private void AddOrderToBatch()
    {
        batchOrders.Add(new OrderFormModel());
        ClearMessages();
    }

    private void RemoveOrderFromBatch(int index)
    {
        batchOrders.RemoveAt(index);
        ClearMessages();
    }

    private void AddProductToOrder(int orderIndex)
    {
        batchOrders[orderIndex].Products.Add(new OrderProductFormModel());
        ClearMessages();
    }

    private void RemoveProductFromOrder(int orderIndex, int productIndex)
    {
        batchOrders[orderIndex].Products.RemoveAt(productIndex);
        ClearMessages();
    }

    private decimal CalculateOrderTotal(OrderFormModel order)
    {
        return order.Products.Sum(p => p.Quantity * p.Price);
    }

    private decimal CalculateGrandTotal()
    {
        return batchOrders.Sum(o => CalculateOrderTotal(o));
    }

    private bool IsBatchValid()
    {
        return batchOrders.Any() && batchOrders.All(o =>
            !string.IsNullOrWhiteSpace(o.Id) &&
            !string.IsNullOrWhiteSpace(o.CustomerId) &&
            !string.IsNullOrWhiteSpace(o.DeliveryAddress) &&
            o.Products.Any() &&
            o.Products.All(p =>
                !string.IsNullOrWhiteSpace(p.ProductId) &&
                !string.IsNullOrWhiteSpace(p.ProductDescription) &&
                p.Quantity > 0 &&
                p.Price > 0));
    }

    private void ClearMessages()
    {
        errorMessage = null;
        successMessage = null;
    }

    private void ClearBatch()
    {
        batchOrders.Clear();
        ClearMessages();
    }

    private void ClearJson()
    {
        jsonInput = string.Empty;
        ClearMessages();
    }

    private async Task ParseJsonAndSubmit()
    {
        ClearMessages();
        
        if (string.IsNullOrWhiteSpace(jsonInput))
        {
            errorMessage = "Please provide JSON input";
            return;
        }

        isLoading = true;

        try
        {
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true,
                AllowTrailingCommas = true,
                ReadCommentHandling = JsonCommentHandling.Skip
            };

            var parsedOrders = JsonSerializer.Deserialize<List<OrderFormModel>>(jsonInput, options);

            if (parsedOrders == null || !parsedOrders.Any())
            {
                errorMessage = "No valid orders found in JSON. Please check your JSON format.";
                return;
            }

            // Validate parsed orders
            var invalidOrders = parsedOrders
                .Select((order, index) => new { Order = order, Index = index })
                .Where(x => string.IsNullOrWhiteSpace(x.Order.Id) ||
                           string.IsNullOrWhiteSpace(x.Order.CustomerId) ||
                           string.IsNullOrWhiteSpace(x.Order.DeliveryAddress) ||
                           !x.Order.Products.Any())
                .ToList();

            if (invalidOrders.Any())
            {
                errorMessage = $"Invalid orders found at positions: {string.Join(", ", invalidOrders.Select(x => x.Index + 1))}. Please ensure all required fields are provided.";
                return;
            }

            batchOrders = parsedOrders;
            await SubmitBatchAsync();
        }
        catch (JsonException ex)
        {
            errorMessage = $"JSON parsing error: {ex.Message}. Please verify your JSON format matches the example.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SubmitBatchAsync()
    {
        if (!IsBatchValid())
        {
            errorMessage = "Please ensure all orders have complete information (ID, Customer ID, Delivery Address, and at least one valid product).";
            return;
        }

        isLoading = true;
        ClearMessages();

        try
        {
            var orders = batchOrders.Select(o => new Order
            {
                Id = o.Id,
                CustomerId = o.CustomerId,
                Date = DateTime.UtcNow,
                DeliveryAddress = o.DeliveryAddress,
                Total = CalculateOrderTotal(o),
                Products = o.Products.Select(p => new OrderProduct
                {
                    Id = Guid.NewGuid().ToString(),
                    OrderId = o.Id,
                    ProductId = p.ProductId,
                    ProductDescription = p.ProductDescription,
                    Quantity = p.Quantity,
                    Price = p.Price
                }).ToList()
            }).ToList();

            await ordersService.PlaceOrdersBatchAsync(orders);
            
            var totalAmount = CalculateGrandTotal();
            successMessage = $"Successfully submitted {orders.Count} order{(orders.Count > 1 ? "s" : "")} with a total value of {totalAmount:C2}!";
            
            ClearBatch();
            ClearJson();
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Network error while submitting orders: {ex.Message}. Please check your connection and try again.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to submit orders: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

# ==============================================================================
# Azure Developer CLI (azd) Configuration
# ==============================================================================
# This configuration defines the infrastructure, services, and lifecycle hooks
# for the Azure Logic Apps Monitoring solution. It orchestrates environment
# setup, provisioning, and post-deployment configuration.
#
# Documentation: https://learn.microsoft.com/azure/developer/azure-developer-cli/
# Last Modified: 2026-01-06
# ==============================================================================

# ------------------------------------------------------------------------------
# Project Metadata
# ------------------------------------------------------------------------------
# Unique identifier for this azd template
name: azure-logicapps-monitoring

# Template version and metadata for azd template gallery
metadata:
  template: azure-logicapps-monitoring@1.0.0

# Minimum azd version required for this project
requiredVersions:
  azd: ">= 1.9.0"

# ------------------------------------------------------------------------------
# Infrastructure Configuration
# ------------------------------------------------------------------------------
# Defines how and where infrastructure is defined and deployed
infra:
  provider: bicep # Infrastructure as Code provider
  path: infra # Directory containing Bicep templates
  module: main # Entry point Bicep module (main.bicep)

# ------------------------------------------------------------------------------
# Lifecycle Hooks
# ------------------------------------------------------------------------------
# Scripts executed at specific points in the azd workflow to automate
# environment validation, configuration, and data generation

hooks:
  # Pre-provisioning validation hook
  # Executes before 'azd provision' to validate workstation prerequisites
  preprovision:
    posix: # Linux/macOS configuration
      shell: sh
      run: ./hooks/preprovision.sh --force --verbose
      continueOnError: false # Fail fast on validation errors
      interactive: true # Allow interactive prompts if needed
    windows: # Windows configuration
      shell: pwsh
      run: |
        dotnet clean app.sln
        dotnet restore app.sln
        dotnet buiold app.sln
        dotnet test app.sln --logger "trx;LogFileName=TestResults.trx"
        ./hooks/preprovision.ps1 -Force -Verbose
      continueOnError: false # Fail fast on validation errors
      interactive: true # Allow interactive prompts if needed

  # Post-provisioning configuration hook
  # Executes after 'azd provision' to configure local development secrets
  # and generate test data for the application
  postprovision:
    posix: # Linux/macOS configuration
      shell: sh
      run: |
        ./hooks/postprovision.sh --force --verbose
        ./hooks/Generate-Orders.sh --force --verbose
      continueOnError: false
      interactive: true
    windows: # Windows configuration
      shell: pwsh
      run: |
        ./hooks/postprovision.ps1 -Force -Verbose
        ./hooks/Generate-Orders.ps1 -Force -Verbose
      continueOnError: false
      interactive: true

  # Pre-deployment hook
  # Executes before 'azd deploy' to configure Logic Apps connections
  # and deploy workflow definitions
  predeploy:
    posix:
      shell: sh
      run: ./hooks/deploy-workflow.sh
      continueOnError: false
      interactive: false # Non-interactive for CI/CD compatibility
    windows:
      shell: pwsh
      run: ./hooks/deploy-workflow.ps1
      continueOnError: false
      interactive: false # Non-interactive for CI/CD compatibility

  postinfradelete:
    posix:
      shell: sh
      run: ./hooks/postinfradelete.sh --force --verbose
      continueOnError: false # Fail fast on cleanup errors
      interactive: false
    windows:
      shell: pwsh
      run: ./hooks/postinfradelete.ps1 -Force -Verbose
      continueOnError: false # Fail fast on cleanup errors
      interactive: false

# ------------------------------------------------------------------------------
# Application Services
# ------------------------------------------------------------------------------
# Defines the application components to be deployed to Azure
# Note: Using .NET Aspire AppHost which orchestrates all services internally

services:
  # .NET Aspire AppHost orchestrating the monitoring solution
  # The AppHost manages Orders API and Web App as child services
  app:
    language: dotnet # Service implementation language
    project: ./app.AppHost/app.AppHost.csproj # Path to project file
    host: containerapp # Target hosting platform (Azure Container Apps)

# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

# ==============================================================================
# AZURE DEVELOPER CLI (azd) CONFIGURATION
# ==============================================================================
#
# Project:      Azure Logic Apps Monitoring Solution
# Description:  Infrastructure-as-Code deployment configuration for the Azure
#               Logic Apps Monitoring solution using .NET Aspire orchestration.
#               This file defines services, infrastructure, and lifecycle hooks.
#
# Architecture: .NET Aspire AppHost â†’ Azure Container Apps
#               â”œâ”€â”€ eShop.Orders.API (REST API)
#               â””â”€â”€ eShop.Web.App (Frontend)
#
# Prerequisites:
#   - Azure CLI >= 2.60.0
#   - Azure Developer CLI (azd) >= 1.11.0
#   - .NET SDK 10.0
#   - Docker (for local development)
#
# Quick Start:
#   1. azd auth login           # Authenticate with Azure
#   2. azd env new <env-name>   # Create new environment
#   3. azd up                   # Provision and deploy
#
# Documentation:
#   - AZD Docs: https://learn.microsoft.com/azure/developer/azure-developer-cli/
#   - Schema:   https://learn.microsoft.com/azure/developer/azure-developer-cli/azd-schema
#
# Version History:
#   - 1.0.0 (2026-01-13): Initial release with .NET Aspire AppHost
#
# Author:       Evilazaro
# Repository:   https://github.com/Evilazaro/Azure-LogicApps-Monitoring
# License:      See LICENSE file in repository root
# ==============================================================================

# ------------------------------------------------------------------------------
# PROJECT METADATA
# ------------------------------------------------------------------------------
# Unique project identifier used for Azure resource naming conventions.
# Must be alphanumeric with hyphens only (no underscores or special characters).
# This name is used as a prefix for all deployed Azure resources.
name: azure-logicapps-monitoring

# Template metadata for azd template gallery and discoverability.
# Required fields for publishing to Azure Developer CLI template gallery.
metadata:
  # Semantic version following format: <template-name>@<major>.<minor>.<patch>
  template: azure-logicapps-monitoring@1.0.0
  # Brief description displayed in template gallery searches
  description: "Azure Logic Apps Monitoring solution with .NET Aspire orchestration"
  # Template maintainer/owner
  author: "Evilazaro"
  # Source code repository URL
  repository: "https://github.com/Evilazaro/Azure-LogicApps-Monitoring"

# Minimum version constraints to ensure compatibility.
# Prevents deployment issues caused by outdated CLI versions.
requiredVersions:
  azd: ">= 1.11.0"

# ------------------------------------------------------------------------------
# INFRASTRUCTURE CONFIGURATION
# ------------------------------------------------------------------------------
# Defines the Infrastructure-as-Code (IaC) provider and entry point.
# Bicep templates provision all Azure resources declaratively.
#
# Infrastructure Organization:
#   infra/
#   â”œâ”€â”€ main.bicep              # Entry point (orchestrator)
#   â”œâ”€â”€ main.parameters.json    # Environment-specific parameters
#   â”œâ”€â”€ types.bicep             # Shared type definitions
#   â”œâ”€â”€ shared/                 # Cross-cutting resources (networking, identity)
#   â””â”€â”€ workload/               # Application-specific resources
#
# Security Note: Infrastructure uses Managed Identity for all service-to-service
# authentication. No secrets or connection strings are stored in code.
infra:
  # IaC provider: 'bicep' (recommended) or 'terraform'
  provider: bicep
  # Relative path to infrastructure templates directory
  path: infra
  # Entry point module name (resolves to infra/main.bicep)
  module: main

# ------------------------------------------------------------------------------
# LIFECYCLE HOOKS
# ------------------------------------------------------------------------------
# Scripts executed at specific points in the azd workflow to automate
# environment validation, configuration, and deployment tasks.
#
# Hook Execution Order:
#   azd provision: preprovision â†’ [bicep deploy] â†’ postprovision
#   azd deploy:    predeploy â†’ [app deploy] â†’ postdeploy
#   azd down:      [resource deletion] â†’ postinfradelete
#   azd up:        All of the above in sequence
#
# Hook Guidelines:
#   - Use 'continueOnError: false' for critical validation hooks
#   - Use 'interactive: true' when user input may be required
#   - Keep hooks idempotent (safe to run multiple times)
#   - Log meaningful progress messages for troubleshooting
#
# Cross-Platform Support:
#   All hooks have both POSIX (sh) and Windows (pwsh) implementations
#   to ensure consistent behavior across development environments.

hooks:
  # ============================================================================
  # PREPROVISION HOOK
  # ============================================================================
  # Purpose: Validate environment prerequisites and build solution before
  #          provisioning Azure infrastructure. Prevents wasted Azure costs
  #          from failed deployments due to build errors.
  #
  # Actions:
  #   1. Clean previous build artifacts
  #   2. Restore NuGet dependencies
  #   3. Build solution in Release configuration
  #   4. Execute unit tests to ensure code quality
  #   5. Run workstation validation checks
  #
  # Exit Behavior: Fails provisioning if any step fails (continueOnError: false)
  preprovision:
    posix:
      shell: sh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        HOOK_START_TIME=$(date +%s)

        # Initialize summary (only in GitHub Actions)
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo "## ðŸ”§ Preprovision Hook" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Started:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # ======================================
        # Build and Test Solution
        # ======================================
        echo "Building and testing solution..."

        # Track build status
        BUILD_STATUS="âœ… Success"
        TEST_STATUS="âœ… Success"
        VALIDATION_STATUS="âœ… Success"

        # Clean
        if ! dotnet clean app.sln --verbosity quiet; then
          BUILD_STATUS="âŒ Clean Failed"
        fi

        # Restore
        if ! dotnet restore app.sln; then
          BUILD_STATUS="âŒ Restore Failed"
        fi

        # Build
        if ! dotnet build app.sln --configuration Release --no-restore; then
          BUILD_STATUS="âŒ Build Failed"
        fi

        # Test
        if ! dotnet test --solution app.sln --configuration Release --no-build --logger "trx;LogFileName=TestResults.trx" --results-directory ./TestResults; then
          TEST_STATUS="âŒ Tests Failed"
        fi

        # ======================================
        # Preprovision Validation
        # ======================================
        # Validates: Azure CLI auth, required tools, quota availability
        if ! ./hooks/preprovision.sh --force --verbose; then
          VALIDATION_STATUS="âŒ Validation Failed"
        fi

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          HOOK_END_TIME=$(date +%s)
          HOOK_DURATION=$((HOOK_END_TIME - HOOK_START_TIME))
          
          echo "### ðŸ“‹ Preprovision Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| .NET Build | $BUILD_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $TEST_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Validation | $VALIDATION_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${HOOK_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Fail if any step failed (POSIX-compatible pattern matching)
          HAS_FAILURE=false
          case "$BUILD_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
          case "$TEST_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
          case "$VALIDATION_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
          
          if [ "$HAS_FAILURE" = "true" ]; then
            echo "> âš ï¸ **Warning:** One or more preprovision tasks failed. Check logs above for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "> âœ… All preprovision tasks completed successfully." >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # Exit based on failure status (works whether GITHUB_STEP_SUMMARY is set or not)
        HAS_FAILURE=false
        case "$BUILD_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
        case "$TEST_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
        case "$VALIDATION_STATUS" in *Failed*) HAS_FAILURE=true ;; esac

        if [ "$HAS_FAILURE" = "true" ]; then
          echo "âŒ One or more preprovision tasks failed"
          exit 1
        fi

        echo "âœ… All preprovision tasks completed successfully"
        exit 0
      continueOnError: false
      interactive: true
    windows:
      shell: pwsh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        $HookStartTime = Get-Date

        # Initialize summary (only in GitHub Actions)
        if ($env:GITHUB_STEP_SUMMARY) {
          "## ðŸ”§ Preprovision Hook" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Started:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') UTC" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }

        # ======================================
        # Build and Test Solution
        # ======================================
        Write-Host "Building and testing solution..." -ForegroundColor Cyan

        # Track build status
        $BuildStatus = "âœ… Success"
        $TestStatus = "âœ… Success"
        $ValidationStatus = "âœ… Success"
        $HasError = $false

        # Clean
        dotnet clean app.sln --verbosity quiet
        if ($LASTEXITCODE -ne 0) { $BuildStatus = "âŒ Clean Failed"; $HasError = $true }

        # Restore
        dotnet restore app.sln
        if ($LASTEXITCODE -ne 0) { $BuildStatus = "âŒ Restore Failed"; $HasError = $true }

        # Build
        dotnet build app.sln --configuration Release --no-restore
        if ($LASTEXITCODE -ne 0) { $BuildStatus = "âŒ Build Failed"; $HasError = $true }

        # Test
        dotnet test app.sln --configuration Release --no-build --logger "trx;LogFileName=TestResults.trx" --results-directory ./TestResults
        if ($LASTEXITCODE -ne 0) { $TestStatus = "âŒ Tests Failed"; $HasError = $true }

        # ======================================
        # Preprovision Validation
        # ======================================
        # Validates: Azure CLI auth, required tools, quota availability
        ./hooks/preprovision.ps1 -Force -Verbose
        if ($LASTEXITCODE -ne 0) { $ValidationStatus = "âŒ Validation Failed"; $HasError = $true }

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if ($env:GITHUB_STEP_SUMMARY) {
          $HookDuration = [math]::Round(((Get-Date) - $HookStartTime).TotalSeconds)
          
          "### ðŸ“‹ Preprovision Results" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Task | Status |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "|------|--------|" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| .NET Build | $BuildStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Unit Tests | $TestStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Environment Validation | $ValidationStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Duration:** ${HookDuration}s" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          if ($HasError) {
            "> âš ï¸ **Warning:** One or more preprovision tasks failed. Check logs above for details." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          } else {
            "> âœ… All preprovision tasks completed successfully." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }
        }

        # Exit based on failure status (works whether GITHUB_STEP_SUMMARY is set or not)
        if ($HasError) {
          Write-Host "âŒ One or more preprovision tasks failed" -ForegroundColor Red
          exit 1
        }

        Write-Host "âœ… All preprovision tasks completed successfully" -ForegroundColor Green
        exit 0
      continueOnError: false
      interactive: true

  # ============================================================================
  # POSTPROVISION HOOK
  # ============================================================================
  # Purpose: Configure local development environment after infrastructure
  #          provisioning completes. Sets up secrets and generates test data.
  #
  # Actions:
  #   1. Configure local development secrets from Azure Key Vault
  #   2. Generate sample order data for testing
  #
  # Security Note: Secrets are retrieved from Azure Key Vault using Managed
  # Identity and stored in local user secrets (not committed to source control).
  postprovision:
    posix:
      shell: sh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        HOOK_START_TIME=$(date +%s)

        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo "## âš™ï¸ Postprovision Hook" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Started:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Track status
        SECRETS_STATUS="âœ… Success"
        TESTDATA_STATUS="âœ… Success"

        # Configure local secrets from Azure Key Vault
        if ! ./hooks/postprovision.sh --force --verbose; then
          SECRETS_STATUS="âŒ Failed"
        fi

        # Generate test data for development
        if ! ./hooks/Generate-Orders.sh --force --verbose; then
          TESTDATA_STATUS="âŒ Failed"
        fi

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          HOOK_END_TIME=$(date +%s)
          HOOK_DURATION=$((HOOK_END_TIME - HOOK_START_TIME))
          
          echo "### ðŸ“‹ Postprovision Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Configure Secrets | $SECRETS_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Generate Test Data | $TESTDATA_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${HOOK_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for failures (POSIX-compatible pattern matching)
          HAS_FAILURE=false
          case "$SECRETS_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
          case "$TESTDATA_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
          
          if [ "$HAS_FAILURE" = "true" ]; then
            echo "> âš ï¸ **Warning:** One or more postprovision tasks failed." >> $GITHUB_STEP_SUMMARY
          else
            echo "> âœ… Infrastructure configured successfully." >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # Exit based on failure status (works whether GITHUB_STEP_SUMMARY is set or not)
        HAS_FAILURE=false
        case "$SECRETS_STATUS" in *Failed*) HAS_FAILURE=true ;; esac
        case "$TESTDATA_STATUS" in *Failed*) HAS_FAILURE=true ;; esac

        if [ "$HAS_FAILURE" = "true" ]; then
          echo "âŒ One or more postprovision tasks failed"
          exit 1
        fi

        echo "âœ… Postprovision completed successfully"
        exit 0
      continueOnError: false
      interactive: true
    windows:
      shell: pwsh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        $HookStartTime = Get-Date

        if ($env:GITHUB_STEP_SUMMARY) {
          "## âš™ï¸ Postprovision Hook" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Started:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') UTC" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }

        # Track status
        $SecretsStatus = "âœ… Success"
        $TestDataStatus = "âœ… Success"
        $HasError = $false

        # Configure local secrets from Azure Key Vault
        ./hooks/postprovision.ps1 -Force -Verbose
        if ($LASTEXITCODE -ne 0) { $SecretsStatus = "âŒ Failed"; $HasError = $true }

        # Generate test data for development
        ./hooks/Generate-Orders.ps1 -Force -Verbose
        if ($LASTEXITCODE -ne 0) { $TestDataStatus = "âŒ Failed"; $HasError = $true }

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if ($env:GITHUB_STEP_SUMMARY) {
          $HookDuration = [math]::Round(((Get-Date) - $HookStartTime).TotalSeconds)
          
          "### ðŸ“‹ Postprovision Results" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Task | Status |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "|------|--------|" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Configure Secrets | $SecretsStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Generate Test Data | $TestDataStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Duration:** ${HookDuration}s" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          if ($HasError) {
            "> âš ï¸ **Warning:** One or more postprovision tasks failed." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          } else {
            "> âœ… Infrastructure configured successfully." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }
        }

        # Exit based on failure status (works whether GITHUB_STEP_SUMMARY is set or not)
        if ($HasError) {
          Write-Host "âŒ One or more postprovision tasks failed" -ForegroundColor Red
          exit 1
        }

        Write-Host "âœ… Postprovision completed successfully" -ForegroundColor Green
        exit 0
      continueOnError: false
      interactive: true

  # ============================================================================
  # PREDEPLOY HOOK
  # ============================================================================
  # Purpose: Configure Logic Apps connections and deploy workflow definitions
  #          before deploying application code.
  #
  # Actions:
  #   1. Update Logic Apps connection configurations
  #   2. Deploy workflow definitions to Logic Apps
  #   3. Validate connection authentications
  #
  # Dependencies: Requires infrastructure to be provisioned (Logic App must exist)
  predeploy:
    posix:
      shell: sh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        HOOK_START_TIME=$(date +%s)

        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo "## ðŸš€ Predeploy Hook" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Started:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Track status
        WORKFLOW_STATUS="âœ… Success"

        # Deploy Logic Apps workflows and configure connections
        if ! ./hooks/deploy-workflow.sh; then
          WORKFLOW_STATUS="âŒ Failed"
        fi

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          HOOK_END_TIME=$(date +%s)
          HOOK_DURATION=$((HOOK_END_TIME - HOOK_START_TIME))
          
          echo "### ðŸ“‹ Predeploy Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Logic Apps Workflows | $WORKFLOW_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Configure Connections | $WORKFLOW_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${HOOK_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for failures (POSIX-compatible pattern matching)
          case "$WORKFLOW_STATUS" in
            *Failed*)
              echo "> âš ï¸ **Warning:** Workflow deployment failed. Check logs above." >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "> âœ… Logic Apps workflows deployed successfully." >> $GITHUB_STEP_SUMMARY
              ;;
          esac
        fi

        # Exit based on failure status (works whether GITHUB_STEP_SUMMARY is set or not)
        case "$WORKFLOW_STATUS" in
          *Failed*)
            echo "âŒ Workflow deployment failed"
            exit 1
            ;;
        esac

        echo "âœ… Predeploy completed successfully"
        exit 0
      continueOnError: false
      interactive: true
    windows:
      shell: pwsh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        $HookStartTime = Get-Date

        if ($env:GITHUB_STEP_SUMMARY) {
          "## ðŸš€ Predeploy Hook" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Started:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') UTC" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }

        # Track status
        $WorkflowStatus = "âœ… Success"
        $HasError = $false

        # Deploy Logic Apps workflows and configure connections
        ./hooks/deploy-workflow.ps1
        if ($LASTEXITCODE -ne 0) { $WorkflowStatus = "âŒ Failed"; $HasError = $true }

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if ($env:GITHUB_STEP_SUMMARY) {
          $HookDuration = [math]::Round(((Get-Date) - $HookStartTime).TotalSeconds)
          
          "### ðŸ“‹ Predeploy Results" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Task | Status |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "|------|--------|" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Deploy Logic Apps Workflows | $WorkflowStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Configure Connections | $WorkflowStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Duration:** ${HookDuration}s" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          if ($HasError) {
            "> âš ï¸ **Warning:** Workflow deployment failed. Check logs above." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          } else {
            "> âœ… Logic Apps workflows deployed successfully." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }
        }

        # Exit based on failure status (works whether GITHUB_STEP_SUMMARY is set or not)
        if ($HasError) {
          Write-Host "âŒ Workflow deployment failed" -ForegroundColor Red
          exit 1
        }

        Write-Host "âœ… Predeploy completed successfully" -ForegroundColor Green
        exit 0
      continueOnError: false
      interactive: true

  # ============================================================================
  # POSTDEPLOY HOOK
  # ============================================================================
  # Purpose: Validate deployment success and perform smoke tests to ensure
  #          all services are running correctly.
  #
  # Actions:
  #   1. Display deployment completion status
  #   2. Validate deployed resource health
  #   3. Run basic connectivity tests
  #
  # Note: Failures here do not roll back deployment but alert to potential issues
  postdeploy:
    posix:
      shell: sh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        HOOK_START_TIME=$(date +%s)

        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo "## âœ… Postdeploy Hook" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Started:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "=========================================="
        echo "Deployment completed successfully!"
        echo "=========================================="
        echo "Validating deployed resources..."

        # Track health check status
        HEALTH_STATUS="âœ… Success"
        # Note: Add health check URLs here when available
        # if ! curl -s -o /dev/null -w "%{http_code}" https://<app-url>/health | grep -q "200"; then
        #   HEALTH_STATUS="âŒ Failed"
        # fi

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          HOOK_END_TIME=$(date +%s)
          HOOK_DURATION=$((HOOK_END_TIME - HOOK_START_TIME))
          
          echo "### ðŸ“‹ Postdeploy Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Validation | $HEALTH_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Health Check | $HEALTH_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${HOOK_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ‰ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The application has been successfully deployed to Azure." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Container Apps | ðŸŸ¢ Running |" >> $GITHUB_STEP_SUMMARY
          echo "| Logic Apps | ðŸŸ¢ Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ðŸŸ¢ Provisioned |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "âœ… Postdeploy completed successfully"
        exit 0
      continueOnError: false
      interactive: true
    windows:
      shell: pwsh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        $HookStartTime = Get-Date

        if ($env:GITHUB_STEP_SUMMARY) {
          "## âœ… Postdeploy Hook" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Started:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') UTC" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }

        Write-Host "==========================================" -ForegroundColor Green
        Write-Host "Deployment completed successfully!" -ForegroundColor Green
        Write-Host "==========================================" -ForegroundColor Green
        Write-Host "Validating deployed resources..." -ForegroundColor Cyan

        # Track health check status
        $HealthStatus = "âœ… Success"
        # Note: Add health check URLs here when available
        # try {
        #   $response = Invoke-WebRequest -Uri "https://<app-url>/health" -UseBasicParsing
        #   if ($response.StatusCode -ne 200) { $HealthStatus = "âŒ Failed" }
        # } catch { $HealthStatus = "âŒ Failed" }

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if ($env:GITHUB_STEP_SUMMARY) {
          $HookDuration = [math]::Round(((Get-Date) - $HookStartTime).TotalSeconds)
          
          "### ðŸ“‹ Postdeploy Results" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Task | Status |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "|------|--------|" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Deployment Validation | $HealthStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Resource Health Check | $HealthStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Duration:** ${HookDuration}s" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          "### ðŸŽ‰ Deployment Complete" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "The application has been successfully deployed to Azure." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Resource | Status |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "|----------|--------|" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Container Apps | ðŸŸ¢ Running |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Logic Apps | ðŸŸ¢ Deployed |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Infrastructure | ðŸŸ¢ Provisioned |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }

        Write-Host "âœ… Postdeploy completed successfully" -ForegroundColor Green
        exit 0
      continueOnError: false
      interactive: true

  # ============================================================================
  # POSTINFRADELETE HOOK
  # ============================================================================
  # Purpose: Clean up any remaining resources after infrastructure deletion
  #          that may not be automatically removed by Bicep.
  #
  # Actions:
  #   1. Clean up soft-deleted Key Vault instances
  #   2. Remove orphaned role assignments
  #   3. Clear local cached credentials
  #
  # Note: Azure Key Vault has soft-delete enabled by default; this hook
  # handles purging if required for environment recreation.
  postinfradelete:
    posix:
      shell: sh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        HOOK_START_TIME=$(date +%s)

        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo "## ðŸ—‘ï¸ Postinfradelete Hook" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Started:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Track status
        CLEANUP_STATUS="âœ… Success"

        # Clean up remaining resources and local state
        if ! ./hooks/postinfradelete.sh --force --verbose; then
          CLEANUP_STATUS="âš ï¸ Partial"
        fi

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          HOOK_END_TIME=$(date +%s)
          HOOK_DURATION=$((HOOK_END_TIME - HOOK_START_TIME))
          
          echo "### ðŸ“‹ Cleanup Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Purge Key Vault | $CLEANUP_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Remove Role Assignments | $CLEANUP_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Clear Local Cache | $CLEANUP_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${HOOK_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "> ðŸ§¹ Infrastructure cleanup completed. Environment is ready for recreation." >> $GITHUB_STEP_SUMMARY
        fi

        echo "âœ… Postinfradelete cleanup completed"
        exit 0
      continueOnError: false
      interactive: true
    windows:
      shell: pwsh
      run: |
        # ======================================
        # GitHub Actions Summary - Start
        # ======================================
        $HookStartTime = Get-Date

        if ($env:GITHUB_STEP_SUMMARY) {
          "## ðŸ—‘ï¸ Postinfradelete Hook" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Started:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') UTC" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }

        # Track status
        $CleanupStatus = "âœ… Success"

        # Clean up remaining resources and local state
        ./hooks/postinfradelete.ps1 -Force -Verbose
        if ($LASTEXITCODE -ne 0) { $CleanupStatus = "âš ï¸ Partial" }

        # ======================================
        # GitHub Actions Summary - End
        # ======================================
        if ($env:GITHUB_STEP_SUMMARY) {
          $HookDuration = [math]::Round(((Get-Date) - $HookStartTime).TotalSeconds)
          
          "### ðŸ“‹ Cleanup Results" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Task | Status |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "|------|--------|" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Purge Key Vault | $CleanupStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Remove Role Assignments | $CleanupStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Clear Local Cache | $CleanupStatus |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "**Duration:** ${HookDuration}s" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          "> ðŸ§¹ Infrastructure cleanup completed. Environment is ready for recreation." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        }

        Write-Host "âœ… Postinfradelete cleanup completed" -ForegroundColor Green
        exit 0
      continueOnError: false
      interactive: true

# ------------------------------------------------------------------------------
# APPLICATION SERVICES
# ------------------------------------------------------------------------------
# Defines the application components to be deployed to Azure.
#
# Architecture Overview:
# This solution uses .NET Aspire AppHost as the orchestration layer, which
# automatically discovers, configures, and manages all dependent services.
#
# Service Topology:
#   app.AppHost (Aspire Orchestrator)
#   â”œâ”€â”€ eShop.Orders.API    â†’ REST API for order management
#   â”œâ”€â”€ eShop.Web.App       â†’ Blazor frontend application
#   â”œâ”€â”€ Azure SQL Database  â†’ Order data persistence
#   â”œâ”€â”€ Azure Service Bus   â†’ Async messaging
#   â”œâ”€â”€ Azure Storage       â†’ Blob/Queue storage
#   â””â”€â”€ Application Insights â†’ Telemetry & monitoring
#
# Deployment Target: Azure Container Apps (managed Kubernetes)
# Benefits:
#   - Automatic scaling based on HTTP traffic or queue depth
#   - Built-in ingress with TLS termination
#   - Integrated revision management for zero-downtime deployments
#   - Native .NET Aspire integration

services:
  # ==========================================================================
  # .NET Aspire AppHost
  # ==========================================================================
  # The AppHost is the central orchestrator that:
  #   - Discovers and references all application projects
  #   - Configures service discovery between components
  #   - Manages Azure resource connections (SQL, Service Bus, etc.)
  #   - Generates container configurations for deployment
  #
  # Note: All child services (Orders.API, Web.App) are automatically
  # deployed as part of the AppHost deployment. Do not define them
  # separately as individual services.
  app:
    # Runtime/language for the service
    language: dotnet
    # Relative path to the .csproj file (from repository root)
    project: ./app.AppHost/app.AppHost.csproj
    # Azure hosting platform: containerapp | appservice | function | staticwebapp
    host: containerapp

# ------------------------------------------------------------------------------
# CI/CD PIPELINE CONFIGURATION
# ------------------------------------------------------------------------------
# Configuration for automated pipeline generation via 'azd pipeline config'.
#
# Supported Providers:
#   - github: GitHub Actions (recommended for GitHub repositories)
#   - azdo:   Azure DevOps Pipelines
#
# Generated Workflow Features:
#   - Automated builds on push/PR
#   - Environment-based deployments (dev, staging, prod)
#   - Secret management via GitHub Secrets / Azure Key Vault
#   - Infrastructure drift detection
#
# Usage:
#   azd pipeline config                    # Interactive setup
#   azd pipeline config --provider github  # Non-interactive

pipeline:
  # CI/CD provider: 'github' or 'azdo'
  provider: github
# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
# For troubleshooting and additional configuration options, see:
#   - azd docs: https://learn.microsoft.com/azure/developer/azure-developer-cli/
#   - Schema reference: https://aka.ms/azure-dev/schema
#   - Project issues: https://github.com/Evilazaro/Azure-LogicApps-Monitoring/issues
# ==============================================================================

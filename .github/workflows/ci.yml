# ==============================================================================
# CONTINUOUS INTEGRATION (CI) PIPELINE
# ==============================================================================
#
# Purpose:      Validates code quality by building .NET projects and compiling
#               Bicep infrastructure templates on every push and pull request.
#
# Triggers:     - Push to any branch
#               - Pull requests targeting main branch
#               - Manual workflow dispatch
#
# Validations:  This pipeline performs compilation checks only (no deployment):
#               â”œâ”€â”€ .NET Build: Compiles all .NET projects in the solution
#               â”œâ”€â”€ .NET Tests: Runs unit tests to validate code correctness
#               â””â”€â”€ Bicep Build: Validates and compiles infrastructure templates
#
# Prerequisites:
#   - .NET SDK 10.x (installed automatically)
#   - Azure CLI with Bicep (installed automatically)
#
# Documentation:
#   - .NET CLI:  https://learn.microsoft.com/dotnet/core/tools/
#   - Bicep CLI: https://learn.microsoft.com/azure/azure-resource-manager/bicep/
#
# Author:       Evilazaro
# Repository:   https://github.com/Evilazaro/Azure-LogicApps-Monitoring
# ==============================================================================

# ------------------------------------------------------------------------------
# WORKFLOW METADATA
# ------------------------------------------------------------------------------
name: "CI - Build Validation"

# ------------------------------------------------------------------------------
# TRIGGER CONFIGURATION
# ------------------------------------------------------------------------------
# Workflow executes on:
#   1. Push events to any branch (validates all commits)
#   2. Pull requests targeting main (gate for merging)
#   3. Manual trigger via GitHub Actions UI
on:
    workflow_dispatch:

    push:
        branches:
            - "**"
        # Only run when code files change
        paths:
            - "**.cs"
            - "**.csproj"
            - "**.sln"
            - "**.bicep"
            - "**.json"
            - ".github/workflows/ci.yml"

    pull_request:
        branches:
            - main
        paths:
            - "**.cs"
            - "**.csproj"
            - "**.sln"
            - "**.bicep"
            - "**.json"
            - ".github/workflows/ci.yml"

# ------------------------------------------------------------------------------
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Prevents redundant CI runs for the same branch/PR.
# Cancels in-progress runs when new commits are pushed.
# For PRs, uses PR number to allow parallel runs across different PRs.
concurrency:
    group: ci-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

# ------------------------------------------------------------------------------
# SECURITY PERMISSIONS
# ------------------------------------------------------------------------------
# Minimal permissions following principle of least privilege.
# - contents: read    â†’ Required for repository checkout
# - pull-requests: read â†’ Required for PR metadata access
# - statuses: write   â†’ Required to report commit status checks
permissions:
    contents: read
    pull-requests: read
    statuses: write

# ------------------------------------------------------------------------------
# JOBS DEFINITION
# ------------------------------------------------------------------------------
jobs:
    # ============================================================================
    # JOB: build-dotnet
    # ============================================================================
    # Compiles all .NET projects to validate code syntax and dependencies.
    # Runs restore, build, and optionally tests.
    # ============================================================================
    build-dotnet:
        name: "ðŸ”¨ Build .NET Solution"
        runs-on: ubuntu-latest
        timeout-minutes: 15

        # --------------------------------------------------------------------------
        # Job outputs - Available for downstream jobs or workflows
        # --------------------------------------------------------------------------
        outputs:
            dotnet-version: ${{ steps.setup-dotnet.outputs.dotnet-version }}

        steps:
            # ------------------------------------------------------------------------
            # Step 1: Checkout repository
            # ------------------------------------------------------------------------
            - name: "ðŸ“¥ Checkout repository"
              uses: actions/checkout@v4

            # ------------------------------------------------------------------------
            # Step 2: Setup .NET SDK
            # ------------------------------------------------------------------------
            # Installs required .NET SDK versions for building .NET Aspire projects.
            # ------------------------------------------------------------------------
            - name: "ðŸ”§ Setup .NET SDK"
              id: setup-dotnet
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: |
                      8.x
                      9.x
                      10.x

            # ------------------------------------------------------------------------
            # Step 3: Restore NuGet packages
            # ------------------------------------------------------------------------
            # Downloads and caches all NuGet dependencies defined in project files.
            # ------------------------------------------------------------------------
            - name: "ðŸ“¦ Restore dependencies"
              run: dotnet restore app.sln --verbosity minimal

            # ------------------------------------------------------------------------
            # Step 4: Build solution
            # ------------------------------------------------------------------------
            # Compiles all projects in Release configuration.
            # --no-restore: Uses packages from previous step for efficiency.
            # /warnaserror: Treats warnings as errors for stricter validation.
            # ------------------------------------------------------------------------
            - name: "ðŸ—ï¸ Build solution"
              run: dotnet build app.sln --configuration Release --no-restore /p:TreatWarningsAsErrors=false

            # ------------------------------------------------------------------------
            # Step 5: Run unit tests
            # ------------------------------------------------------------------------
            # Executes all unit tests in the solution.
            # --no-build: Uses build output from previous step for efficiency.
            # --logger trx: Generates test results in TRX format for reporting.
            # ------------------------------------------------------------------------
            - name: "ðŸ§ª Run unit tests"
              run: dotnet test app.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --results-directory ./TestResults

            # ------------------------------------------------------------------------
            # Step 6: Upload test results
            # ------------------------------------------------------------------------
            # Uploads test results as artifacts for later analysis.
            # Runs always to capture results even on test failures.
            # ------------------------------------------------------------------------
            - name: "ðŸ“¤ Upload test results"
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results
                  path: ./TestResults/*.trx
                  retention-days: 7

            # ------------------------------------------------------------------------
            # Step 7: Generate build summary
            # ------------------------------------------------------------------------
            # Creates a GitHub Actions job summary with build and test results.
            # Runs always to provide visibility even on failures.
            # ------------------------------------------------------------------------
            - name: "ðŸ“‹ Generate Build Summary"
              if: always()
              run: |
                  echo "## ðŸ”¨ .NET Build & Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | ${{ job.status == 'success' && 'âœ… Passed' || job.status == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Configuration** | Release |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Solution** | \`app.sln\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Tests** | Unit tests executed |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [[ "${{ job.status }}" != "success" ]]; then
                    echo "> **Note:** Check the build/test logs above for detailed error information." >> $GITHUB_STEP_SUMMARY
                  fi

    # ============================================================================
    # JOB: build-bicep
    # ============================================================================
    # Validates and compiles Bicep infrastructure templates.
    # Ensures IaC syntax is correct without deploying to Azure.
    # ============================================================================
    build-bicep:
        name: "â˜ï¸ Build Bicep Templates"
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            # ------------------------------------------------------------------------
            # Step 1: Checkout repository
            # ------------------------------------------------------------------------
            - name: "ðŸ“¥ Checkout repository"
              uses: actions/checkout@v4

            # ------------------------------------------------------------------------
            # Step 2: Setup Azure CLI and install Bicep
            # ------------------------------------------------------------------------
            # Azure CLI Docker image doesn't include Bicep by default.
            # Install Bicep CLI for template compilation.
            # No authentication needed - only local compilation.
            # ------------------------------------------------------------------------
            - name: "ðŸ”§ Setup Azure CLI and Bicep"
              uses: azure/cli@v2
              with:
                  inlineScript: |
                      az --version
                      az bicep install
                      az bicep version

            # ------------------------------------------------------------------------
            # Step 3: Build main Bicep template
            # ------------------------------------------------------------------------
            # Compiles the main infrastructure template and all referenced modules.
            # Validates syntax, type checking, and module references.
            # Building main.bicep automatically validates all imported modules.
            # ------------------------------------------------------------------------
            - name: "ðŸ—ï¸ Build main.bicep"
              uses: azure/cli@v2
              with:
                  inlineScript: |
                      az bicep install
                      echo "Building infra/main.bicep..."
                      az bicep build --file infra/main.bicep --stdout > /dev/null
                      echo "âœ… infra/main.bicep compiled successfully"

            # ------------------------------------------------------------------------
            # Step 4: Generate build summary
            # ------------------------------------------------------------------------
            # Creates a GitHub Actions job summary with Bicep compilation results.
            # Runs always to provide visibility even on failures.
            # ------------------------------------------------------------------------
            - name: "ðŸ“‹ Generate Build Summary"
              if: always()
              run: |
                  echo "## â˜ï¸ Bicep Build Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Template | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| \`infra/main.bicep\` | ${{ job.status == 'success' && 'âœ… Compiled' || job.status == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | ${{ job.status == 'success' && 'âœ… Passed' || job.status == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [[ "${{ job.status }}" != "success" ]]; then
                    echo "> **Note:** Check the Bicep compilation logs above for detailed error information." >> $GITHUB_STEP_SUMMARY
                  fi

    # ============================================================================
    # JOB: ci-summary
    # ============================================================================
    # Aggregates results from all CI jobs and provides a unified status.
    # This job is used as a single status check for branch protection rules.
    # ============================================================================
    ci-summary:
        name: "âœ… CI Summary"
        runs-on: ubuntu-latest
        needs: [build-dotnet, build-bicep]
        if: always()
        timeout-minutes: 5

        steps:
            # ------------------------------------------------------------------------
            # Step 1: Check job results
            # ------------------------------------------------------------------------
            # Evaluates the status of all dependent jobs and fails if any failed.
            # This provides a single status check for branch protection rules.
            # ------------------------------------------------------------------------
            - name: "ðŸ” Evaluate CI Results"
              run: |
                  echo "## ðŸ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| .NET Build | ${{ needs.build-dotnet.result == 'success' && 'âœ… Passed' || needs.build-dotnet.result == 'skipped' && 'â­ï¸ Skipped' || needs.build-dotnet.result == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Bicep Build | ${{ needs.build-bicep.result == 'success' && 'âœ… Passed' || needs.build-bicep.result == 'skipped' && 'â­ï¸ Skipped' || needs.build-bicep.result == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Workflow** | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Run Number** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Determine overall status
                  if [[ "${{ needs.build-dotnet.result }}" == "success" && "${{ needs.build-bicep.result }}" == "success" ]]; then
                    echo "### âœ… All CI checks passed!" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "This branch is ready for deployment." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "### âŒ CI checks failed" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "> **Action Required:** Fix the failing jobs before merging." >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi

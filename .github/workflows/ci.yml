# ==============================================================================
# CONTINUOUS INTEGRATION (CI) PIPELINE
# ==============================================================================
#
# Purpose:      Validates code quality by building .NET projects and compiling
#               Bicep infrastructure templates on every push and pull request.
#
# Triggers:     - Push to any branch
#               - Pull requests targeting main branch
#               - Manual workflow dispatch
#
# Validations:  This pipeline performs compilation checks only (no deployment):
#               â”œâ”€â”€ .NET Build: Compiles all .NET projects in the solution
#               â”œâ”€â”€ .NET Tests: Runs unit tests to validate code correctness
#               â””â”€â”€ Bicep Build: Validates and compiles infrastructure templates
#
# Prerequisites:
#   - .NET SDK 10.x (installed automatically)
#   - Azure CLI with Bicep (installed automatically)
#
# Documentation:
#   - .NET CLI:  https://learn.microsoft.com/dotnet/core/tools/
#   - Bicep CLI: https://learn.microsoft.com/azure/azure-resource-manager/bicep/
#
# Author:       Evilazaro
# Repository:   https://github.com/Evilazaro/Azure-LogicApps-Monitoring
# ==============================================================================

# ------------------------------------------------------------------------------
# WORKFLOW METADATA
# ------------------------------------------------------------------------------
name: "CI - Build Validation"

# ------------------------------------------------------------------------------
# TRIGGER CONFIGURATION
# ------------------------------------------------------------------------------
# Workflow executes on:
#   1. Push events to any branch (validates all commits)
#   2. Pull requests targeting main (gate for merging)
#   3. Manual trigger via GitHub Actions UI
on:
    workflow_dispatch:

    push:
        branches:
            - "**"
        # Only run when code files change
        paths:
            - "**.cs"
            - "**.csproj"
            - "**.sln"
            - "**.bicep"
            - "**.json"
            - ".github/workflows/ci.yml"

    pull_request:
        branches:
            - main
        paths:
            - "**.cs"
            - "**.csproj"
            - "**.sln"
            - "**.bicep"
            - "**.json"
            - ".github/workflows/ci.yml"

# ------------------------------------------------------------------------------
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Prevents redundant CI runs for the same branch/PR.
# Cancels in-progress runs when new commits are pushed.
# For PRs, uses PR number to allow parallel runs across different PRs.
concurrency:
    group: ci-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

# ------------------------------------------------------------------------------
# SECURITY PERMISSIONS
# ------------------------------------------------------------------------------
# Minimal permissions following principle of least privilege.
# - contents: read     â†’ Required for repository checkout
# - pull-requests: read â†’ Required for PR metadata access
# - statuses: write    â†’ Required to report commit status checks
# - checks: write      â†’ Required for test-reporter to create check runs
permissions:
    contents: read
    pull-requests: read
    statuses: write
    checks: write

# ------------------------------------------------------------------------------
# JOBS DEFINITION
# ------------------------------------------------------------------------------
jobs:
    # ============================================================================
    # JOB: build-dotnet
    # ============================================================================
    # Compiles all .NET projects to validate code syntax and dependencies.
    # Runs restore, build, and optionally tests.
    # ============================================================================
    build-dotnet:
        name: "ðŸ”¨ Build .NET Solution"
        runs-on: ubuntu-latest
        timeout-minutes: 15

        # --------------------------------------------------------------------------
        # Job outputs - Available for downstream jobs or workflows
        # --------------------------------------------------------------------------
        outputs:
            dotnet-version: ${{ steps.setup-dotnet.outputs.dotnet-version }}

        steps:
            # ------------------------------------------------------------------------
            # Step 1: Checkout repository
            # ------------------------------------------------------------------------
            - name: "ðŸ“¥ Checkout repository"
              uses: actions/checkout@v4

            # ------------------------------------------------------------------------
            # Step 2: Setup .NET SDK
            # ------------------------------------------------------------------------
            # Installs required .NET SDK versions for building .NET Aspire projects.
            # ------------------------------------------------------------------------
            - name: "ðŸ”§ Setup .NET SDK"
              id: setup-dotnet
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: |
                      8.x
                      9.x
                      10.x

            # ------------------------------------------------------------------------
            # Step 3: Restore NuGet packages
            # ------------------------------------------------------------------------
            # Downloads and caches all NuGet dependencies defined in project files.
            # ------------------------------------------------------------------------
            - name: "ðŸ“¦ Restore dependencies"
              run: dotnet restore app.sln --verbosity minimal

            # ------------------------------------------------------------------------
            # Step 4: Build solution
            # ------------------------------------------------------------------------
            # Compiles all projects in Release configuration.
            # --no-restore: Uses packages from previous step for efficiency.
            # /warnaserror: Treats warnings as errors for stricter validation.
            # ------------------------------------------------------------------------
            - name: "ðŸ—ï¸ Build solution"
              run: dotnet build app.sln --configuration Release --no-restore /p:TreatWarningsAsErrors=false

            # ------------------------------------------------------------------------
            # Step 5: Run unit tests
            # ------------------------------------------------------------------------
            # Executes all unit tests in the solution and captures results.
            # Uses --logger trx for standard VSTest TRX output.
            # continue-on-error: Allows subsequent steps to parse results on failure.
            # ------------------------------------------------------------------------
            - name: "ðŸ§ª Run unit tests"
              id: test
              continue-on-error: true
              run: |
                  # Create TestResults directory to ensure it exists
                  mkdir -p TestResults

                  # Run tests with TRX logger (standard VSTest approach)
                  dotnet test app.sln \
                    --configuration Release \
                    --no-build \
                    --verbosity normal \
                    --logger "trx;LogFileName=test-results.trx" \
                    --results-directory TestResults

                  TEST_EXIT_CODE=$?

                  # Debug: List test results
                  echo "::group::Test Results Directory Contents"
                  echo "Looking for TRX files..."
                  find . -name "*.trx" -type f 2>/dev/null || echo "No TRX files found with find"
                  echo "TestResults directory:"
                  ls -la TestResults/ 2>/dev/null || echo "TestResults directory not found or empty"
                  echo "::endgroup::"

                  exit $TEST_EXIT_CODE

            # ------------------------------------------------------------------------
            # Step 6: Parse test results
            # ------------------------------------------------------------------------
            # Extracts test metrics from TRX files for job summary.
            # Parses total, passed, failed, and skipped test counts.
            # Sets outputs for use in summary generation.
            # ------------------------------------------------------------------------
            - name: "ðŸ“Š Parse test results"
              id: test-results
              if: always()
              run: |
                  # Initialize counters
                  TOTAL=0
                  PASSED=0
                  FAILED=0
                  SKIPPED=0
                  DURATION="0.00s"

                  # Find and parse TRX files
                  if [ -d "TestResults" ]; then
                    for trx in TestResults/*.trx; do
                      if [ -f "$trx" ]; then
                        echo "Parsing: $trx"
                        
                        # Extract test counts using grep and sed
                        # TRX format: <Counters total="X" executed="Y" passed="Z" failed="A" .../>
                        COUNTERS=$(grep -oP '<Counters[^>]+>' "$trx" | head -1 || echo "")
                        
                        if [ -n "$COUNTERS" ]; then
                          FILE_TOTAL=$(echo "$COUNTERS" | grep -oP 'total="\K[0-9]+' || echo "0")
                          FILE_PASSED=$(echo "$COUNTERS" | grep -oP 'passed="\K[0-9]+' || echo "0")
                          FILE_FAILED=$(echo "$COUNTERS" | grep -oP 'failed="\K[0-9]+' || echo "0")
                          FILE_SKIPPED=$(echo "$COUNTERS" | grep -oP 'notExecuted="\K[0-9]+' || echo "0")
                          
                          TOTAL=$((TOTAL + FILE_TOTAL))
                          PASSED=$((PASSED + FILE_PASSED))
                          FAILED=$((FAILED + FILE_FAILED))
                          SKIPPED=$((SKIPPED + FILE_SKIPPED))
                        fi
                        
                        # Extract duration
                        TIMES=$(grep -oP '<Times[^>]+>' "$trx" | head -1 || echo "")
                        if [ -n "$TIMES" ]; then
                          START=$(echo "$TIMES" | grep -oP 'start="\K[^"]+' || echo "")
                          FINISH=$(echo "$TIMES" | grep -oP 'finish="\K[^"]+' || echo "")
                          if [ -n "$START" ] && [ -n "$FINISH" ]; then
                            # Calculate duration in seconds (simplified)
                            DURATION_SEC=$(( $(date -d "$FINISH" +%s 2>/dev/null || echo 0) - $(date -d "$START" +%s 2>/dev/null || echo 0) ))
                            if [ "$DURATION_SEC" -gt 0 ]; then
                              DURATION="${DURATION_SEC}s"
                            fi
                          fi
                        fi
                      fi
                    done
                  fi

                  # Set outputs
                  echo "total=$TOTAL" >> $GITHUB_OUTPUT
                  echo "passed=$PASSED" >> $GITHUB_OUTPUT
                  echo "failed=$FAILED" >> $GITHUB_OUTPUT
                  echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
                  echo "duration=$DURATION" >> $GITHUB_OUTPUT

                  # Log results
                  echo "::group::Test Results Summary"
                  echo "Total:   $TOTAL"
                  echo "Passed:  $PASSED"
                  echo "Failed:  $FAILED"
                  echo "Skipped: $SKIPPED"
                  echo "Duration: $DURATION"
                  echo "::endgroup::"

                  # Set job status based on test results
                  if [ "$FAILED" -gt 0 ]; then
                    echo "::error::$FAILED test(s) failed"
                    echo "test-status=failed" >> $GITHUB_OUTPUT
                  elif [ "$TOTAL" -eq 0 ]; then
                    echo "::warning::No tests were found"
                    echo "test-status=no-tests" >> $GITHUB_OUTPUT
                  else
                    echo "::notice::All $PASSED tests passed"
                    echo "test-status=passed" >> $GITHUB_OUTPUT
                  fi

            # ------------------------------------------------------------------------
            # Step 7: Upload test results artifact
            # ------------------------------------------------------------------------
            # Uploads TRX files as artifacts for download and analysis.
            # Runs always to capture results even on test failures.
            # ------------------------------------------------------------------------
            - name: "ðŸ“¤ Upload test results"
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results
                  path: TestResults
                  retention-days: 14
                  if-no-files-found: warn

            # ------------------------------------------------------------------------
            # Step 8: Generate test report (PR annotations)
            # ------------------------------------------------------------------------
            # Creates a test report with inline annotations for failed tests.
            # Only runs on pull requests to annotate code with failures.
            # Uses dorny/test-reporter for rich GitHub integration.
            # Only runs if TRX files exist to avoid errors.
            # ------------------------------------------------------------------------
            - name: "ðŸ“ Generate test report"
              uses: dorny/test-reporter@v1
              if: always() && hashFiles('TestResults/*.trx') != ''
              with:
                  name: "Unit Test Results"
                  path: "TestResults/*.trx"
                  reporter: dotnet-trx
                  fail-on-error: false

            # ------------------------------------------------------------------------
            # Step 9: Generate build summary
            # ------------------------------------------------------------------------
            # Creates a GitHub Actions job summary with build and test results.
            # Displays actual test metrics from TRX parsing.
            # Runs always to provide visibility even on failures.
            # ------------------------------------------------------------------------
            - name: "ðŸ“‹ Generate Build Summary"
              if: always()
              run: |
                  # Get test results from previous step
                  TOTAL="${{ steps.test-results.outputs.total || '0' }}"
                  PASSED="${{ steps.test-results.outputs.passed || '0' }}"
                  FAILED="${{ steps.test-results.outputs.failed || '0' }}"
                  SKIPPED="${{ steps.test-results.outputs.skipped || '0' }}"
                  DURATION="${{ steps.test-results.outputs.duration || 'N/A' }}"
                  TEST_STATUS="${{ steps.test-results.outputs.test-status || 'unknown' }}"

                  # Determine test status icon
                  if [ "$FAILED" -gt 0 ]; then
                    TEST_ICON="âŒ"
                    TEST_STATUS_TEXT="Failed"
                  elif [ "$TOTAL" -eq 0 ]; then
                    TEST_ICON="âš ï¸"
                    TEST_STATUS_TEXT="No Tests"
                  else
                    TEST_ICON="âœ…"
                    TEST_STATUS_TEXT="Passed"
                  fi

                  # Build summary header
                  echo "## ðŸ”¨ .NET Build & Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Build status
                  echo "### ðŸ—ï¸ Build Status" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | ${{ job.status == 'success' && 'âœ… Passed' || job.status == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Configuration** | Release |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Solution** | \`app.sln\` |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Test results section
                  echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
                  echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Total Tests** | $TOTAL |" >> $GITHUB_STEP_SUMMARY
                  echo "| **âœ… Passed** | $PASSED |" >> $GITHUB_STEP_SUMMARY
                  echo "| **âŒ Failed** | $FAILED |" >> $GITHUB_STEP_SUMMARY
                  echo "| **â­ï¸ Skipped** | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
                  echo "| **â±ï¸ Duration** | $DURATION |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | $TEST_ICON $TEST_STATUS_TEXT |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Test result visualization
                  if [ "$TOTAL" -gt 0 ]; then
                    PASS_PCT=$((PASSED * 100 / TOTAL))
                    echo "**Pass Rate:** $PASS_PCT% ($PASSED/$TOTAL)" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi

                  # Run information
                  echo "### ðŸ“Š Run Information" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Workflow Run** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Conditional messages
                  if [ "$FAILED" -gt 0 ]; then
                    echo "### âŒ Test Failures Detected" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "> **Action Required:** Review the test report above for details on failed tests." >> $GITHUB_STEP_SUMMARY
                    echo "> Download the \`test-results\` artifact for full TRX files." >> $GITHUB_STEP_SUMMARY
                  elif [[ "${{ job.status }}" != "success" ]]; then
                    echo "> **Note:** Check the build logs above for detailed error information." >> $GITHUB_STEP_SUMMARY
                  fi

            # ------------------------------------------------------------------------
            # Step 10: Fail job if tests failed
            # ------------------------------------------------------------------------
            # Ensures the job fails if any tests failed.
            # This step runs after summary generation to preserve visibility.
            # ------------------------------------------------------------------------
            - name: "ðŸš¨ Check test results"
              if: always() && steps.test.outcome == 'failure'
              run: |
                  echo "::error::Unit tests failed. See test report for details."
                  exit 1

    # ============================================================================
    # JOB: build-bicep
    # ============================================================================
    # Validates and compiles Bicep infrastructure templates.
    # Ensures IaC syntax is correct without deploying to Azure.
    # ============================================================================
    build-bicep:
        name: "â˜ï¸ Build Bicep Templates"
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            # ------------------------------------------------------------------------
            # Step 1: Checkout repository
            # ------------------------------------------------------------------------
            - name: "ðŸ“¥ Checkout repository"
              uses: actions/checkout@v4

            # ------------------------------------------------------------------------
            # Step 2: Setup Azure CLI and install Bicep
            # ------------------------------------------------------------------------
            # Azure CLI Docker image doesn't include Bicep by default.
            # Install Bicep CLI for template compilation.
            # No authentication needed - only local compilation.
            # ------------------------------------------------------------------------
            - name: "ðŸ”§ Setup Azure CLI and Bicep"
              uses: azure/cli@v2
              with:
                  inlineScript: |
                      az --version
                      az bicep install
                      az bicep version

            # ------------------------------------------------------------------------
            # Step 3: Build main Bicep template
            # ------------------------------------------------------------------------
            # Compiles the main infrastructure template and all referenced modules.
            # Validates syntax, type checking, and module references.
            # Building main.bicep automatically validates all imported modules.
            # ------------------------------------------------------------------------
            - name: "ðŸ—ï¸ Build main.bicep"
              uses: azure/cli@v2
              with:
                  inlineScript: |
                      az bicep install
                      echo "Building infra/main.bicep..."
                      az bicep build --file infra/main.bicep --stdout > /dev/null
                      echo "âœ… infra/main.bicep compiled successfully"

            # ------------------------------------------------------------------------
            # Step 4: Generate build summary
            # ------------------------------------------------------------------------
            # Creates a GitHub Actions job summary with Bicep compilation results.
            # Runs always to provide visibility even on failures.
            # ------------------------------------------------------------------------
            - name: "ðŸ“‹ Generate Build Summary"
              if: always()
              run: |
                  echo "## â˜ï¸ Bicep Build Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Template | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| \`infra/main.bicep\` | ${{ job.status == 'success' && 'âœ… Compiled' || job.status == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | ${{ job.status == 'success' && 'âœ… Passed' || job.status == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [[ "${{ job.status }}" != "success" ]]; then
                    echo "> **Note:** Check the Bicep compilation logs above for detailed error information." >> $GITHUB_STEP_SUMMARY
                  fi

    # ============================================================================
    # JOB: ci-summary
    # ============================================================================
    # Aggregates results from all CI jobs and provides a unified status.
    # This job is used as a single status check for branch protection rules.
    # ============================================================================
    ci-summary:
        name: "âœ… CI Summary"
        runs-on: ubuntu-latest
        needs: [build-dotnet, build-bicep]
        if: always()
        timeout-minutes: 5

        steps:
            # ------------------------------------------------------------------------
            # Step 1: Check job results
            # ------------------------------------------------------------------------
            # Evaluates the status of all dependent jobs and fails if any failed.
            # This provides a single status check for branch protection rules.
            # ------------------------------------------------------------------------
            - name: "ðŸ” Evaluate CI Results"
              run: |
                  echo "## ðŸ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| .NET Build | ${{ needs.build-dotnet.result == 'success' && 'âœ… Passed' || needs.build-dotnet.result == 'skipped' && 'â­ï¸ Skipped' || needs.build-dotnet.result == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Bicep Build | ${{ needs.build-bicep.result == 'success' && 'âœ… Passed' || needs.build-bicep.result == 'skipped' && 'â­ï¸ Skipped' || needs.build-bicep.result == 'cancelled' && 'âš ï¸ Cancelled' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Workflow** | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Run Number** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Determine overall status
                  if [[ "${{ needs.build-dotnet.result }}" == "success" && "${{ needs.build-bicep.result }}" == "success" ]]; then
                    echo "### âœ… All CI checks passed!" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "This branch is ready for deployment." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "### âŒ CI checks failed" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "> **Action Required:** Fix the failing jobs before merging." >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi

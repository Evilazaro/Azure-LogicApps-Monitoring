# ============================================================================
# .NET Continuous Integration - Reusable Workflow
# ============================================================================
#
# Purpose:
#   Reusable workflow that builds, tests, and analyzes .NET solutions.
#   Can be called from other workflows with customizable parameters.
#
# Usage:
#   jobs:
#     ci:
#       uses: ./.github/workflows/ci-dotnet-reusable.yml
#       with:
#         configuration: 'Release'
#         dotnet-version: '10.0.x'
#       secrets: inherit
#
# Documentation:
#   https://docs.github.com/en/actions/using-workflows/reusing-workflows
#
# ============================================================================

name: CI - .NET Reusable Workflow

on:
    workflow_call:
        # --------------------------------------------------------------------------
        # Input Parameters
        # --------------------------------------------------------------------------
        inputs:
            configuration:
                description: "Build configuration (Release/Debug)"
                required: false
                type: string
                default: "Release"

            dotnet-version:
                description: ".NET SDK version to use"
                required: false
                type: string
                default: "10.0.x"

            solution-file:
                description: "Path to the solution file"
                required: false
                type: string
                default: "app.sln"

            test-results-artifact-name:
                description: "Name for test results artifact"
                required: false
                type: string
                default: "test-results"

            build-artifacts-name:
                description: "Name for build artifacts"
                required: false
                type: string
                default: "build-artifacts"

            coverage-artifact-name:
                description: "Name for code coverage artifact"
                required: false
                type: string
                default: "code-coverage"

            artifact-retention-days:
                description: "Number of days to retain artifacts"
                required: false
                type: number
                default: 30

            runs-on:
                description: "Runner to use for jobs"
                required: false
                type: string
                default: "ubuntu-latest"

            enable-code-analysis:
                description: "Enable code formatting analysis"
                required: false
                type: boolean
                default: true

            fail-on-format-issues:
                description: "Fail workflow if code formatting issues are found"
                required: false
                type: boolean
                default: true

        # --------------------------------------------------------------------------
        # Output Parameters
        # --------------------------------------------------------------------------
        outputs:
            build-version:
                description: "The generated build version"
                value: ${{ jobs.build.outputs.build-version }}

            build-result:
                description: "Build job result"
                value: ${{ jobs.build.result }}

            test-result:
                description: "Test job result"
                value: ${{ jobs.test.result }}

            analyze-result:
                description: "Analysis job result"
                value: ${{ jobs.analyze.result }}

# ------------------------------------------------------------------------------
# Workflow-level Permissions (Least Privilege)
# ------------------------------------------------------------------------------
permissions:
    contents: read
    checks: write
    pull-requests: write

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
    DOTNET_NOLOGO: true
    DOTNET_CLI_TELEMETRY_OPTOUT: true

# ------------------------------------------------------------------------------
# Default Shell Configuration
# ------------------------------------------------------------------------------
defaults:
    run:
        shell: bash

jobs:
    # ============================================================================
    # Build Job
    # ============================================================================
    build:
        name: üî® Build
        runs-on: ${{ inputs.runs-on }}
        timeout-minutes: 15
        outputs:
            build-version: ${{ steps.version.outputs.version }}

        steps:
            - name: üì• Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  fetch-depth: 0

            - name: üîß Setup .NET SDK
              uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
              with:
                  dotnet-version: ${{ inputs.dotnet-version }}

            - name: ‚òÅÔ∏è Update .NET workloads
              run: sudo dotnet workload update

            - name: üè∑Ô∏è Generate build version
              id: version
              run: |
                  VERSION="1.0.${{ github.run_number }}"
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "::notice title=Build Version::$VERSION"

            - name: üì• Restore dependencies
              run: dotnet restore ${{ inputs.solution-file }} --verbosity minimal

            - name: üî® Build solution
              run: |
                  echo "::group::üî® Building solution"
                  echo "‚Üí Configuration: ${{ inputs.configuration }}"
                  echo "‚Üí Version: ${{ steps.version.outputs.version }}"
                  echo ""
                  dotnet build ${{ inputs.solution-file }} \
                    --configuration ${{ inputs.configuration }} \
                    --no-restore \
                    /p:Version=${{ steps.version.outputs.version }} \
                    /p:ContinuousIntegrationBuild=true
                  echo "::endgroup::"
                  echo "::notice title=Build::‚úÖ Solution built successfully (${{ inputs.configuration }})"

            - name: üì§ Upload build artifacts
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
              with:
                  name: ${{ inputs.build-artifacts-name }}
                  path: |
                      **/bin/${{ inputs.configuration }}/**
                      !**/bin/${{ inputs.configuration }}/**/ref/**
                  retention-days: 7
                  if-no-files-found: error

            - name: üìä Generate build summary
              if: always()
              run: |
                  echo "## üî® Build Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Status badge
                  if [ "${{ job.status }}" == "success" ]; then
                    echo "![Build Status](https://img.shields.io/badge/build-passing-brightgreen)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "![Build Status](https://img.shields.io/badge/build-failing-red)" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Main info table
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | $( [ '${{ job.status }}' == 'success' ] && echo '‚úÖ Passed' || echo '‚ùå Failed' ) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Configuration** | \`${{ inputs.configuration }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Version** | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **.NET Version** | \`${{ inputs.dotnet-version }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Runner** | \`${{ runner.os }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Collapsible details
                  echo "<details>" >> $GITHUB_STEP_SUMMARY
                  echo "<summary>üìã Git Information</summary>" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Actor** | [@${{ github.actor }}](${{ github.server_url }}/${{ github.actor }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "</details>" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Artifacts section
                  echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "- **${{ inputs.build-artifacts-name }}** - Compiled binaries (\`${{ inputs.configuration }}\` configuration)" >> $GITHUB_STEP_SUMMARY

    # ============================================================================
    # Test Job
    # ============================================================================
    test:
        name: üß™ Test
        runs-on: ${{ inputs.runs-on }}
        timeout-minutes: 30
        needs: build

        steps:
            - name: üì• Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: üîß Setup .NET SDK
              uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
              with:
                  dotnet-version: ${{ inputs.dotnet-version }}

            - name: ‚òÅÔ∏è Update .NET workloads
              run: |
                  echo "::group::üì¶ Updating .NET workloads"
                  sudo dotnet workload update
                  echo "::endgroup::"

            - name: üì• Restore dependencies
              run: |
                  echo "::group::üì¶ Restoring NuGet packages"
                  dotnet restore ${{ inputs.solution-file }} --verbosity minimal
                  echo "::endgroup::"

            - name: üî® Build solution
              run: |
                  echo "::group::üî® Building for tests"
                  dotnet build ${{ inputs.solution-file }} --configuration ${{ inputs.configuration }} --no-restore
                  echo "::endgroup::"

            - name: üß™ Run tests with coverage
              run: |
                  echo "::group::üß™ Executing tests with coverage"
                  echo "‚Üí Configuration: ${{ inputs.configuration }}"
                  echo "‚Üí Coverage format: Cobertura"
                  echo ""
                  dotnet test --solution ${{ inputs.solution-file }} \
                    --configuration ${{ inputs.configuration }} \
                    --no-restore \
                    --verbosity normal \
                    --report-trx \
                    --report-trx-filename test-results.trx \
                    --results-directory "${{ github.workspace }}/TestResults" \
                    --coverage \
                    --coverage-output-format cobertura \
                    --coverage-output coverage.cobertura.xml
                  echo "::endgroup::"
                  echo "::notice title=Tests::‚úÖ All tests passed"

            - name: üìã Publish test results
              uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2.5.0
              if: always()
              with:
                  name: "Test Results"
                  path: "${{ github.workspace }}/TestResults/**/*.trx"
                  reporter: dotnet-trx
                  fail-on-error: true

            - name: üì§ Upload test results
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
              if: always()
              with:
                  name: ${{ inputs.test-results-artifact-name }}
                  path: ${{ github.workspace }}/TestResults
                  retention-days: ${{ inputs.artifact-retention-days }}

            - name: üì§ Upload code coverage
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
              if: always()
              with:
                  name: ${{ inputs.coverage-artifact-name }}
                  path: ${{ github.workspace }}/TestResults/**/coverage.cobertura.xml
                  retention-days: ${{ inputs.artifact-retention-days }}

            - name: üìä Generate test summary
              if: always()
              run: |
                  echo "## üß™ Test Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Status badge
                  if [ "${{ job.status }}" == "success" ]; then
                    echo "![Test Status](https://img.shields.io/badge/tests-passing-brightgreen)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "![Test Status](https://img.shields.io/badge/tests-failing-red)" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Main info table
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Status** | $( [ '${{ job.status }}' == 'success' ] && echo '‚úÖ Passed' || echo '‚ùå Failed' ) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Configuration** | \`${{ inputs.configuration }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Test Framework** | Microsoft.Testing.Platform |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Coverage Format** | Cobertura |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Artifacts section
                  echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "| Artifact | Description |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **${{ inputs.test-results-artifact-name }}** | Test execution results (.trx) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **${{ inputs.coverage-artifact-name }}** | Code coverage reports (Cobertura XML) |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Troubleshooting on failure
                  if [ "${{ job.status }}" != "success" ]; then
                    echo "<details>" >> $GITHUB_STEP_SUMMARY
                    echo "<summary>üîß Troubleshooting Tips</summary>" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "1. Download the **${{ inputs.test-results-artifact-name }}** artifact for detailed results" >> $GITHUB_STEP_SUMMARY
                    echo "2. Run tests locally: \`dotnet test ${{ inputs.solution-file }}\`" >> $GITHUB_STEP_SUMMARY
                    echo "3. Check for flaky tests or environment-specific issues" >> $GITHUB_STEP_SUMMARY
                    echo "4. Review the [Test Reporter](#) check for individual test failures" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "</details>" >> $GITHUB_STEP_SUMMARY
                  fi

    # ============================================================================
    # Code Analysis Job
    # ============================================================================
    analyze:
        name: üîç Analyze
        runs-on: ${{ inputs.runs-on }}
        timeout-minutes: 15
        needs: build
        if: ${{ inputs.enable-code-analysis }}

        steps:
            - name: üì• Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: üîß Setup .NET SDK
              uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
              with:
                  dotnet-version: ${{ inputs.dotnet-version }}

            - name: ‚òÅÔ∏è Update .NET workloads
              run: |
                  echo "::group::üì¶ Updating .NET workloads"
                  sudo dotnet workload update
                  echo "::endgroup::"

            - name: üì• Restore dependencies
              run: |
                  echo "::group::üì¶ Restoring NuGet packages"
                  dotnet restore ${{ inputs.solution-file }} --verbosity minimal
                  echo "::endgroup::"

            - name: üé® Verify code formatting
              id: format-check
              run: |
                  echo "::group::üé® Checking code format"
                  echo "‚Üí Analyzing: ${{ inputs.solution-file }}"
                  echo "‚Üí Verifying .editorconfig compliance"
                  echo ""
                  if dotnet format ${{ inputs.solution-file }} --verify-no-changes --verbosity diagnostic; then
                    echo "::endgroup::"
                    echo "::notice title=Code Format::‚úÖ All files are properly formatted"
                  else
                    echo "::endgroup::"
                    echo "::warning title=Code Format::‚ö†Ô∏è Formatting issues detected. Run 'dotnet format' locally to fix."
                    exit 1
                  fi
              continue-on-error: true

            - name: üìä Generate analysis summary
              if: always()
              run: |
                  echo "## üîç Code Analysis Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Status badge
                  if [ "${{ steps.format-check.outcome }}" == "success" ]; then
                    echo "![Analysis Status](https://img.shields.io/badge/analysis-passing-brightgreen)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "![Analysis Status](https://img.shields.io/badge/analysis-issues%20found-yellow)" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Results table
                  echo "| Check | Status | Description |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ steps.format-check.outcome }}" == "success" ]; then
                    echo "| üé® Code Formatting | ‚úÖ Passed | Code follows .editorconfig standards |" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| üé® Code Formatting | ‚ùå Failed | Formatting issues detected |" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Show fix instructions on failure
                  if [ "${{ steps.format-check.outcome }}" != "success" ]; then
                    echo "### üîß How to Fix" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                    echo "# Auto-fix all formatting issues" >> $GITHUB_STEP_SUMMARY
                    echo "dotnet format ${{ inputs.solution-file }}" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "# Verify changes" >> $GITHUB_STEP_SUMMARY
                    echo "dotnet format ${{ inputs.solution-file }} --verify-no-changes" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi

                  # Tips section (collapsible)
                  echo "<details>" >> $GITHUB_STEP_SUMMARY
                  echo "<summary>üí° Best Practices</summary>" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- Run \`dotnet format\` before committing to auto-fix formatting issues" >> $GITHUB_STEP_SUMMARY
                  echo "- Configure your IDE to format on save using \`.editorconfig\`" >> $GITHUB_STEP_SUMMARY
                  echo "- Consider adding a [pre-commit hook](https://pre-commit.com/) for automatic formatting" >> $GITHUB_STEP_SUMMARY
                  echo "- Use \`dotnet format --verify-no-changes\` in your local workflow" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "</details>" >> $GITHUB_STEP_SUMMARY

            - name: ‚ùå Fail on format issues
              if: ${{ steps.format-check.outcome == 'failure' && inputs.fail-on-format-issues }}
              run: exit 1

    # ============================================================================
    # Workflow Summary Job
    # ============================================================================
    summary:
        name: üìä Summary
        runs-on: ${{ inputs.runs-on }}
        timeout-minutes: 5
        needs: [build, test, analyze]
        if: always()

        steps:
            - name: üìä Generate workflow summary
              run: |
                  echo "# üöÄ CI Workflow Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Overall status determination
                  if [ "${{ needs.build.result }}" == "success" ] && \
                     [ "${{ needs.test.result }}" == "success" ] && \
                     ([ "${{ needs.analyze.result }}" == "success" ] || [ "${{ needs.analyze.result }}" == "skipped" ]); then
                    echo "![CI Status](https://img.shields.io/badge/CI-passing-brightgreen?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "![CI Status](https://img.shields.io/badge/CI-failing-red?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Horizontal rule
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  echo "## üìã Job Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status | Description |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|-------------|" >> $GITHUB_STEP_SUMMARY

                  # Build status
                  if [ "${{ needs.build.result }}" == "success" ]; then
                    echo "| üî® Build | ‚úÖ Passed | Solution compiled successfully |" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| üî® Build | ‚ùå Failed | Compilation errors detected |" >> $GITHUB_STEP_SUMMARY
                  fi

                  # Test status
                  if [ "${{ needs.test.result }}" == "success" ]; then
                    echo "| üß™ Test | ‚úÖ Passed | All tests executed successfully |" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| üß™ Test | ‚ùå Failed | Test failures detected |" >> $GITHUB_STEP_SUMMARY
                  fi

                  # Analyze status
                  if [ "${{ needs.analyze.result }}" == "success" ]; then
                    echo "| üîç Analyze | ‚úÖ Passed | Code meets quality standards |" >> $GITHUB_STEP_SUMMARY
                  elif [ "${{ needs.analyze.result }}" == "skipped" ]; then
                    echo "| üîç Analyze | ‚è≠Ô∏è Skipped | Code analysis disabled |" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| üîç Analyze | ‚ùå Failed | Code quality issues found |" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Workflow Details (collapsible)
                  echo "<details>" >> $GITHUB_STEP_SUMMARY
                  echo "<summary>üìù Workflow Details</summary>" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Workflow** | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Run ID** | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Run Number** | \`#${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | [\`${{ github.ref_name }}\`](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Actor** | [@${{ github.actor }}](${{ github.server_url }}/${{ github.actor }}) |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "</details>" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Artifacts section
                  echo "## üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Artifact | Description | Retention |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------------|-----------|" >> $GITHUB_STEP_SUMMARY
                  echo "| üìÅ **build-artifacts** | Compiled binaries | 7 days |" >> $GITHUB_STEP_SUMMARY
                  echo "| üìã **test-results** | Test execution results (.trx) | 30 days |" >> $GITHUB_STEP_SUMMARY
                  echo "| üìä **code-coverage** | Coverage reports (Cobertura) | 30 days |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Next steps on failure
                  if [ "${{ needs.build.result }}" != "success" ] || \
                     [ "${{ needs.test.result }}" != "success" ] || \
                     ([ "${{ needs.analyze.result }}" != "success" ] && [ "${{ needs.analyze.result }}" != "skipped" ]); then
                    echo "---" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "## ‚ö†Ô∏è Action Required" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "Some checks have failed. Please review the individual job summaries above for details." >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Quick Actions:**" >> $GITHUB_STEP_SUMMARY
                    echo "- üîÑ [Re-run failed jobs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
                    echo "- üìñ Check the job logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
                    echo "- üí¨ Ask for help in the PR comments if needed" >> $GITHUB_STEP_SUMMARY
                  fi

# ============================================================================
# Azure Developer CLI - Continuous Delivery Workflow
# ============================================================================
#
# Purpose:
#   Provisions Azure infrastructure and deploys the .NET application using
#   Azure Developer CLI (azd) with OpenID Connect (OIDC) authentication.
#
# Pipeline Flow:
#   CI (Build ‚Üí Test ‚Üí Analyze ‚Üí CodeQL) ‚Üí Deploy to Dev
#
# CI Jobs (via reusable workflow):
#   1. Build     - Cross-platform compilation (Ubuntu, Windows, macOS)
#   2. Test      - Cross-platform testing with coverage
#   3. Analyze   - Code formatting verification
#   4. CodeQL    - Security vulnerability scanning (always runs)
#
# Features:
#   - Integrated CI pipeline with security scanning
#   - OIDC authentication (no stored secrets)
#   - Environment-based deployment with protection rules
#   - Deployment summaries and observability
#
# Prerequisites:
#   - Federated credentials configured in Azure AD
#   - GitHub Environment: dev
#   - Repository variables: AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID
#
# Documentation:
#   https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure
#
# ============================================================================

name: CD - Azure Deployment

# ------------------------------------------------------------------------------
# Trigger Configuration
# ------------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      skip-ci:
        description: "Skip CI checks (use with caution)"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - docs987678
    paths:
      - "src/**"
      - "app.*/**"
      - "infra/**"
      - "azure.yaml"
      - ".github/workflows/azure-dev.yml"

# ------------------------------------------------------------------------------
# Concurrency Configuration
# Prevents simultaneous deployments to the same environment
# ------------------------------------------------------------------------------
concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: false

# ------------------------------------------------------------------------------
# Workflow-level Permissions (Least Privilege)
# - id-token: write       - Required for OIDC authentication with Azure
# - contents: read        - Read repository contents for checkout
# - checks: write         - Create check runs for test results
# - pull-requests: write  - Post comments on pull requests
# - security-events: write - Upload CodeQL SARIF results to Security tab
# ------------------------------------------------------------------------------
permissions:
  id-token: write
  contents: read
  checks: write
  pull-requests: write
  security-events: write

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
  DOTNET_VERSION: "10.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

# ------------------------------------------------------------------------------
# Default Shell Configuration
# ------------------------------------------------------------------------------
defaults:
  run:
    shell: bash

jobs:
  # ============================================================================
  # CI Job - Build, Test, Analyze, and Security Scan
  # ============================================================================
  # Executes the comprehensive CI pipeline before deployment:
  # - Build and Test run on all platforms (Ubuntu, Windows, macOS)
  # - Analyze verifies code formatting
  # - CodeQL performs security vulnerability scanning (always runs)
  # ============================================================================
  ci:
    name: üîÑ CI
    if: ${{ github.event.inputs.skip-ci != 'true' }}
    uses: ./.github/workflows/ci-dotnet-reusable.yml
    with:
      configuration: "Release"
      dotnet-version: "10.0.x"
      solution-file: "app.sln"
      enable-code-analysis: true
      fail-on-format-issues: false
    secrets: inherit

  # ============================================================================
  # Deploy to Dev Environment
  # ============================================================================
  deploy-dev:
    name: üöÄ Deploy Dev
    runs-on: ubuntu-latest
    needs: [ci]
    if: |
      always() && 
      (needs.ci.result == 'success' || needs.ci.result == 'skipped')
    timeout-minutes: 30
    environment:
      name: dev
      url: ${{ steps.deploy.outputs.webapp-url }}

    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME || 'dev' }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION || 'eastus2' }}
      DEPLOYER_PRINCIPAL_TYPE: ${{ vars.DEPLOYER_PRINCIPAL_TYPE || 'ServicePrincipal' }}
      DEPLOY_HEALTH_MODEL: ${{ vars.DEPLOY_HEALTH_MODEL }}

    outputs:
      webapp-url: ${{ steps.deploy.outputs.webapp-url }}
      resource-group: ${{ steps.deploy.outputs.resource-group }}

    steps:
      # ------------------------------------------------------------------------
      # Phase 1: Setup
      # ------------------------------------------------------------------------
      - name: üì• Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: üì¶ Install Prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dos2unix software-properties-common

          # Remove any existing ODBC sqlcmd (mssql-tools) to prevent PATH conflicts
          # The ODBC version doesn't support Azure AD authentication
          echo "Checking for existing ODBC sqlcmd installations..."
          if [ -f /opt/mssql-tools/bin/sqlcmd ]; then
            echo "Removing ODBC sqlcmd from /opt/mssql-tools/bin..."
            sudo rm -f /opt/mssql-tools/bin/sqlcmd
          fi
          if [ -f /opt/mssql-tools18/bin/sqlcmd ]; then
            echo "Removing ODBC sqlcmd from /opt/mssql-tools18/bin..."
            sudo rm -f /opt/mssql-tools18/bin/sqlcmd
          fi

          # Install go-sqlcmd (modern sqlcmd with Azure AD authentication support)
          # Reference: https://github.com/microsoft/go-sqlcmd
          # Note: go-sqlcmd is required for --authentication-method ActiveDirectoryAzCli
          echo "Installing go-sqlcmd..."
          SQLCMD_VERSION=$(curl -s https://api.github.com/repos/microsoft/go-sqlcmd/releases/latest | jq -r '.tag_name')
          echo "Latest go-sqlcmd version: $SQLCMD_VERSION"

          # Download and extract go-sqlcmd for Linux amd64
          curl -sSL "https://github.com/microsoft/go-sqlcmd/releases/download/${SQLCMD_VERSION}/sqlcmd-linux-amd64.tar.bz2" -o sqlcmd.tar.bz2
          tar -xjf sqlcmd.tar.bz2
          sudo mv sqlcmd /usr/local/bin/sqlcmd
          sudo chmod +x /usr/local/bin/sqlcmd
          rm -f sqlcmd.tar.bz2

          # Verify go-sqlcmd is installed and is the correct version
          echo "Verifying sqlcmd installation..."
          which sqlcmd
          echo "sqlcmd path: $(which sqlcmd)"
          sqlcmd --version

          # Double-check it's go-sqlcmd (not ODBC)
          if ! sqlcmd --version 2>&1 | grep -qi "go-sqlcmd\|Version:"; then
            echo "ERROR: sqlcmd does not appear to be go-sqlcmd!"
            exit 1
          fi
          echo "‚úì go-sqlcmd installed successfully"

      - name: üîß Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: üîß Setup .NET SDK
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ------------------------------------------------------------------------
      # Phase 2: Authentication
      # ------------------------------------------------------------------------
      - name: üîê Log in with Azure (Federated Credentials)
        run: |
          echo "::group::üîê Authenticating with Azure"
          echo "‚Üí Client ID: $AZURE_CLIENT_ID"
          echo "‚Üí Tenant ID: $AZURE_TENANT_ID"
          echo "‚Üí Method: Federated Credentials (OIDC)"
          echo ""
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"
          echo "::endgroup::"
          echo "::notice title=Azure Auth::‚úÖ Successfully authenticated with Azure"
      - name: üîë Logging in to Azure CLI
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      # ------------------------------------------------------------------------
      # Phase 3: Provision, Reauthenticate & Deploy
      # ------------------------------------------------------------------------
      - name: üèóÔ∏è Provision Infrastructure
        id: provision
        run: |
          echo "::group::üèóÔ∏è Provisioning Azure infrastructure"
          echo "‚Üí Environment: $AZURE_ENV_NAME"
          echo "‚Üí Location: $AZURE_LOCATION"
          echo "‚Üí Subscription: $AZURE_SUBSCRIPTION_ID"
          echo ""
          if azd provision --no-prompt; then
            echo "::endgroup::"
            echo "::notice title=Provision::‚úÖ Infrastructure provisioned successfully"
          else
            echo "::endgroup::"
            echo "::error title=Provision::‚ùå Infrastructure provisioning failed"
            exit 1
          fi

      - name: üîê Log in with Azure (Federated Credentials)
        run: |
          echo "::group::üîê Authenticating with Azure"
          echo "‚Üí Client ID: $AZURE_CLIENT_ID"
          echo "‚Üí Tenant ID: $AZURE_TENANT_ID"
          echo "‚Üí Method: Federated Credentials (OIDC)"
          echo ""
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"
          echo "::endgroup::"
          echo "::notice title=Azure Auth::‚úÖ Successfully authenticated with Azure"
      - name: üîë Logging in to Azure CLI
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: ÔøΩ Debug azd environment values
        run: |
          echo "::group::üîç Checking azd environment values"
          echo "Managed Identity values:"
          azd env get-values | grep -E "MANAGED_IDENTITY|AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY" || echo "No managed identity values found"
          echo ""
          echo "SQL values:"
          azd env get-values | grep -E "SQL|ORDERSDATABASE" || echo "No SQL values found"
          echo "::endgroup::"

      - name: ÔøΩüöÄ Deploy Application
        id: deploy
        run: |
          echo "::group::üöÄ Deploying application to Azure"
          echo "‚Üí Environment: $AZURE_ENV_NAME"
          echo "‚Üí Configuration: Release"
          echo ""
          if azd deploy --no-prompt; then
            echo "::endgroup::"
            echo "::notice title=Deploy::‚úÖ Application deployed successfully"
          else
            echo "::endgroup::"
            echo "::error title=Deploy::‚ùå Application deployment failed"
            exit 1
          fi

          # Extract outputs for summary
          RESOURCE_GROUP="${AZURE_ENV_NAME}-rg"
          AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN="${AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN}"
          echo "resource-group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "webapp-url=https://aspire-dashboard.ext.$AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN" >> $GITHUB_OUTPUT

      - name: üîç Verify Container App Configuration
        run: |
          echo "::group::üîç Checking deployed Container App configuration"
          RG="rg-orders-${AZURE_ENV_NAME}-${AZURE_LOCATION}"
          echo "Resource Group: $RG"
          
          echo ""
          echo "=== Container App Identity ==="
          az containerapp show --name orders-api --resource-group "$RG" --query "identity" -o json || echo "Failed to get identity"
          
          echo ""
          echo "=== AZURE_CLIENT_ID Environment Variable ==="
          az containerapp show --name orders-api --resource-group "$RG" --query "properties.template.containers[0].env[?name=='AZURE_CLIENT_ID']" -o json || echo "Failed to get env var"
          
          echo ""
          echo "=== Expected MANAGED_IDENTITY_CLIENT_ID ==="
          azd env get-values | grep "MANAGED_IDENTITY_CLIENT_ID"
          echo "::endgroup::"

      - name: üîç Verify SQL User Exists
        run: |
          echo "::group::üîç Checking SQL database user"
          SQL_SERVER=$(azd env get-values | grep "AZURE_SQL_SERVER_NAME" | cut -d'=' -f2 | tr -d '"')
          SQL_DB=$(azd env get-values | grep "AZURE_SQL_DATABASE_NAME" | cut -d'=' -f2 | tr -d '"')
          MI_NAME=$(azd env get-values | grep "MANAGED_IDENTITY_NAME" | cut -d'=' -f2 | tr -d '"')
          
          echo "SQL Server: $SQL_SERVER"
          echo "Database: $SQL_DB"
          echo "Managed Identity Name: $MI_NAME"
          echo ""
          
          echo "=== Checking if user exists in database ==="
          sqlcmd -S "${SQL_SERVER}.database.windows.net" -d "$SQL_DB" --authentication-method ActiveDirectoryAzCli -Q "SELECT name, type_desc, authentication_type_desc FROM sys.database_principals WHERE name = '$MI_NAME'" || echo "Failed to query SQL"
          
          echo ""
          echo "=== All external users in database ==="
          sqlcmd -S "${SQL_SERVER}.database.windows.net" -d "$SQL_DB" --authentication-method ActiveDirectoryAzCli -Q "SELECT name, type_desc, authentication_type_desc FROM sys.database_principals WHERE type IN ('E', 'X')" || echo "Failed to query SQL"
          echo "::endgroup::"

      # ------------------------------------------------------------------------
      # Phase 4: Summary
      # ------------------------------------------------------------------------
      - name: üìä Generate deployment summary
        if: always()
        run: |
          echo "## üöÄ Dev Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status badge
          if [ "${{ job.status }}" == "success" ]; then
            echo "![Deployment Status](https://img.shields.io/badge/deployment-successful-brightgreen?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          else
            echo "![Deployment Status](https://img.shields.io/badge/deployment-failed-red?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Environment info
          echo "### üéØ Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | $( [ '${{ job.status }}' == 'success' ] && echo '‚úÖ Deployed' || echo '‚ùå Failed' ) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Environment** | \`$AZURE_ENV_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Location** | \`$AZURE_LOCATION\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Git info (collapsible)
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üìã Deployment Details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | [\`${{ github.ref_name }}\`](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | [@${{ github.actor }}](${{ github.server_url }}/${{ github.actor }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show rollback on failure
          if [ "${{ job.status }}" != "success" ]; then
            echo "### ‚ö†Ô∏è Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üîÑ Rollback Instructions</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To rollback to a previous deployment:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Option 1: Re-run with previous commit" >> $GITHUB_STEP_SUMMARY
            echo "gh workflow run azure-dev.yml --ref <previous-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Option 2: Use Azure Developer CLI locally" >> $GITHUB_STEP_SUMMARY
            echo "git checkout <previous-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "azd deploy --no-prompt" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application has been deployed to the \`dev\` environment." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Workflow Summary Job
  # ============================================================================
  summary:
    name: üìä Summary
    runs-on: ubuntu-latest
    needs: [ci, deploy-dev]
    if: always()
    timeout-minutes: 5

    steps:
      - name: üìä Generate workflow summary
        run: |
          echo "# üöÄ CD Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status determination
          if ([ "${{ needs.ci.result }}" == "success" ] || [ "${{ needs.ci.result }}" == "skipped" ]) && \
             [ "${{ needs.deploy-dev.result }}" == "success" ]; then
            echo "![CD Status](https://img.shields.io/badge/CD-successful-brightgreen?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          else
            echo "![CD Status](https://img.shields.io/badge/CD-failed-red?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìã Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|-------------|" >> $GITHUB_STEP_SUMMARY

          # CI status
          CI_RESULT="${{ needs.ci.result }}"
          if [ "$CI_RESULT" == "success" ]; then
            echo "| üî® CI Pipeline | ‚úÖ Passed | Build, test, and analysis completed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$CI_RESULT" == "skipped" ]; then
            echo "| üî® CI Pipeline | ‚è≠Ô∏è Skipped | CI checks bypassed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üî® CI Pipeline | ‚ùå Failed | CI checks failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Dev deployment status
          DEV_RESULT="${{ needs.deploy-dev.result }}"
          if [ "$DEV_RESULT" == "success" ]; then
            echo "| üöÄ Deploy Dev | ‚úÖ Deployed | Application deployed to dev environment |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DEV_RESULT" == "skipped" ]; then
            echo "| üöÄ Deploy Dev | ‚è≠Ô∏è Skipped | Deployment skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üöÄ Deploy Dev | ‚ùå Failed | Deployment failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Workflow details (collapsible)
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üìù Workflow Details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | [\`${{ github.ref_name }}\`](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | [@${{ github.actor }}](${{ github.server_url }}/${{ github.actor }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Action required on failure
          if [ "${{ needs.deploy-dev.result }}" != "success" ] && [ "${{ needs.deploy-dev.result }}" != "skipped" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ö†Ô∏è Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment pipeline has failed. Please review the logs and take corrective action." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Quick Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "- üîÑ [Re-run workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "- üìñ Check the deployment logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
            echo "- üí¨ Review Azure portal for resource status" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Failure Handler Job (Visual failure path in graph)
  # ============================================================================
  on-failure:
    name: ‚ùå Handle Failure
    runs-on: ubuntu-latest
    needs: [ci, deploy-dev]
    if: failure()
    timeout-minutes: 5

    steps:
      - name: ‚ùå Report failure
        run: |
          echo "::error title=Pipeline Failed::One or more jobs failed. Review the logs above."

          echo "## ‚ùå Pipeline Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîÑ CI | ${{ needs.ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ Deploy Dev | ${{ needs.deploy-dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Click on the failed job above to see detailed logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix the issue in your code" >> $GITHUB_STEP_SUMMARY
          echo "3. Push a new commit or re-run the workflow" >> $GITHUB_STEP_SUMMARY

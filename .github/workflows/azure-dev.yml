# ============================================================================
# Azure Developer CLI - Continuous Delivery Workflow
# ============================================================================
#
# Purpose:
#   Provisions Azure infrastructure and deploys the .NET application using
#   Azure Developer CLI (azd) with OpenID Connect (OIDC) authentication.
#
# Pipeline Flow:
#   CI (build/test/analyze) â†’ Deploy to Dev
#
# Features:
#   - Integrated CI pipeline (build, test, code analysis)
#   - OIDC authentication (no stored secrets)
#   - Environment-based deployment with protection rules
#   - Deployment summaries and observability
#
# Prerequisites:
#   - Federated credentials configured in Azure AD
#   - GitHub Environment: dev
#   - Repository variables: AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID
#
# Documentation:
#   https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure
#
# ============================================================================

name: CD - Azure Deployment

# ------------------------------------------------------------------------------
# Trigger Configuration
# ------------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      skip-ci:
        description: "Skip CI checks (use with caution)"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "app.*/**"
      - "infra/**"
      - "azure.yaml"
      - ".github/workflows/azure-dev.yml"

# ------------------------------------------------------------------------------
# Concurrency Configuration
# Prevents simultaneous deployments to the same environment
# ------------------------------------------------------------------------------
concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: false

# ------------------------------------------------------------------------------
# Workflow-level Permissions (Least Privilege)
# ------------------------------------------------------------------------------
permissions:
  id-token: write
  contents: read
  checks: write
  pull-requests: write

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
  DOTNET_VERSION: "10.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

# ------------------------------------------------------------------------------
# Default Shell Configuration
# ------------------------------------------------------------------------------
defaults:
  run:
    shell: bash

jobs:
  # ============================================================================
  # CI Job - Build, Test, and Analyze
  # ============================================================================
  ci:
    name: ðŸ”¨ CI Pipeline
    if: ${{ github.event.inputs.skip-ci != 'true' }}
    uses: ./.github/workflows/ci-dotnet-reusable.yml
    with:
      configuration: "Release"
      dotnet-version: "10.0.x"
      solution-file: "app.sln"
      enable-code-analysis: true
      fail-on-format-issues: false
    secrets: inherit

  # ============================================================================
  # Deploy to Dev Environment
  # ============================================================================
  deploy-dev:
    name: ðŸš€ Deploy to Dev
    runs-on: ubuntu-latest
    needs: [ci]
    if: |
      always() && 
      (needs.ci.result == 'success' || needs.ci.result == 'skipped')
    timeout-minutes: 30
    environment:
      name: dev
      url: ${{ steps.deploy.outputs.webapp-url }}

    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME || 'dev' }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION || 'eastus2' }}
      DEPLOYER_PRINCIPAL_TYPE: ${{ vars.DEPLOYER_PRINCIPAL_TYPE }}
      DEPLOY_HEALTH_MODEL: ${{ vars.DEPLOY_HEALTH_MODEL }}

    outputs:
      webapp-url: ${{ steps.deploy.outputs.webapp-url }}
      resource-group: ${{ steps.deploy.outputs.resource-group }}

    steps:
      # ------------------------------------------------------------------------
      # Checkout Repository
      # ------------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # ------------------------------------------------------------------------
      # Setup Tools
      # ------------------------------------------------------------------------
      - name: ðŸ”§ Install Azure Developer CLI
        uses: Azure/setup-azd@ae811689366f7cacdb5b7eed75cb72fe0953e6c6 # v2.0.0

      - name: ðŸ”§ Setup .NET SDK
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ------------------------------------------------------------------------
      # Azure Authentication (OIDC)
      # ------------------------------------------------------------------------
      - name: ðŸ” Log in with Azure (Federated Credentials)
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      # ------------------------------------------------------------------------
      # Provision Infrastructure
      # ------------------------------------------------------------------------
      - name: ðŸ—ï¸ Provision Infrastructure
        id: provision
        run: |
          echo "::group::Provisioning Azure resources"
          azd provision --no-prompt --output json > provision-output.json 2>&1 || true
          cat provision-output.json
          echo "::endgroup::"

      # ------------------------------------------------------------------------
      # Deploy Application
      # ------------------------------------------------------------------------
      - name: ðŸš€ Deploy Application
        id: deploy
        run: |
          echo "::group::Deploying application"
          azd deploy --no-prompt
          echo "::endgroup::"

          # Extract outputs for summary
          RESOURCE_GROUP="${AZURE_ENV_NAME}-rg"
          echo "resource-group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "webapp-url=https://${AZURE_ENV_NAME}.azurewebsites.net" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------------
      # Deployment Summary
      # ------------------------------------------------------------------------
      - name: ðŸ“Š Generate deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Dev Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Environment** | \`$AZURE_ENV_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Location** | \`$AZURE_LOCATION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status**: Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Deployment failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”„ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
            echo "To rollback, re-run the workflow with a previous commit:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "gh workflow run azure-dev.yml --ref <previous-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Workflow Summary Job
  # ============================================================================
  summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [ci, deploy-dev]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“Š Generate workflow summary
        run: |
          echo "# ðŸš€ CD Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # CI status
          CI_RESULT="${{ needs.ci.result }}"
          if [ "$CI_RESULT" == "success" ]; then
            echo "| ðŸ”¨ CI Pipeline | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$CI_RESULT" == "skipped" ]; then
            echo "| ðŸ”¨ CI Pipeline | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”¨ CI Pipeline | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Dev deployment status
          DEV_RESULT="${{ needs.deploy-dev.result }}"
          if [ "$DEV_RESULT" == "success" ]; then
            echo "| ðŸš€ Deploy Dev | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DEV_RESULT" == "skipped" ]; then
            echo "| ðŸš€ Deploy Dev | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸš€ Deploy Dev | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

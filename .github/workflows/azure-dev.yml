# ============================================================================
# Azure Developer CLI - Continuous Delivery Workflow
# ============================================================================
#
# Purpose:
#   Provisions Azure infrastructure and deploys the .NET application using
#   Azure Developer CLI (azd) with OpenID Connect (OIDC) authentication.
#
# Pipeline Flow:
#   CI ‚Üí Deploy Dev ‚Üí Summary
#
# Jobs:
#   1. ci          - Reusable CI workflow (Build, Test, Analyze, CodeQL)
#   2. deploy-dev  - Provision infrastructure, configure SQL, deploy application
#   3. summary     - Generate workflow summary report
#   4. on-failure  - Handle and report pipeline failures
#
# Deployment Phases:
#   Phase 1: Setup         - Checkout, install prerequisites (go-sqlcmd), .NET SDK, azd
#   Phase 2: Auth          - OIDC authentication with Azure (azd + az CLI)
#   Phase 3: Provision     - Infrastructure provisioning via azd provision
#   Phase 4: SQL Config    - Create managed identity user in SQL database
#   Phase 5: Re-auth       - Re-authenticate after SQL operations (token refresh)
#   Phase 6: Deploy        - Application deployment via azd deploy
#   Phase 7: Summary       - Generate deployment summary report
#
# Features:
#   - Integrated CI pipeline with security scanning (CodeQL)
#   - OIDC/Federated Credentials authentication (no stored secrets)
#   - Environment-based deployment with protection rules
#   - SQL Managed Identity configuration with go-sqlcmd
#   - Deployment summaries and observability
#
# Prerequisites:
#   - Federated credentials configured in Azure Entra ID
#   - GitHub Environment: dev
#   - Repository variables: AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID
#
# Documentation:
#   https://learn.microsoft.com/en-us/azure/developer/github/connect-from-azure
#
# ============================================================================

name: CD - Azure Deployment

# ------------------------------------------------------------------------------
# Trigger Configuration
# ------------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      skip-ci:
        description: "Skip CI checks (use with caution)"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - docs987678
    paths:
      - "src/**"
      - "app.*/**"
      - "infra/**"
      - "azure.yaml"
      - ".github/workflows/azure-dev.yml"

# ------------------------------------------------------------------------------
# Concurrency Configuration
# Prevents simultaneous deployments to the same environment
# ------------------------------------------------------------------------------
concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: false

# ------------------------------------------------------------------------------
# Workflow-level Permissions (Least Privilege)
# - id-token: write       - Required for OIDC authentication with Azure
# - contents: read        - Read repository contents for checkout
# - checks: write         - Create check runs for test results
# - pull-requests: write  - Post comments on pull requests
# - security-events: write - Upload CodeQL SARIF results to Security tab
# ------------------------------------------------------------------------------
permissions:
  id-token: write
  contents: read
  checks: write
  pull-requests: write
  security-events: write

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
  DOTNET_VERSION: "10.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

# ------------------------------------------------------------------------------
# Default Shell Configuration
# ------------------------------------------------------------------------------
defaults:
  run:
    shell: bash

jobs:
  # ============================================================================
  # CI Job - Reusable Workflow
  # ============================================================================
  # Calls the reusable CI workflow (ci-dotnet-reusable.yml) which executes:
  # - Build: Cross-platform compilation (Ubuntu, Windows, macOS)
  # - Test: Cross-platform testing with coverage reporting
  # - Analyze: Code formatting verification
  # - CodeQL: Security vulnerability scanning
  #
  # Can be skipped via workflow_dispatch input: skip-ci=true
  # ============================================================================
  ci:
    name: üîÑ CI
    if: ${{ github.event.inputs.skip-ci != 'true' }}
    uses: ./.github/workflows/ci-dotnet-reusable.yml
    with:
      configuration: "Release"
      dotnet-version: "10.0.x"
      solution-file: "app.sln"
      enable-code-analysis: true
      fail-on-format-issues: false
    secrets: inherit

  # ============================================================================
  # Deploy to Dev Environment
  # ============================================================================
  # Deploys the application to the dev environment using Azure Developer CLI.
  # Runs after CI succeeds or is skipped. Uses OIDC authentication.
  #
  # Phases: Setup ‚Üí Auth ‚Üí Provision ‚Üí SQL Config ‚Üí Re-auth ‚Üí Deploy ‚Üí Summary
  # ============================================================================
  deploy-dev:
    name: üöÄ Deploy Dev
    runs-on: ubuntu-latest
    needs: [ci]
    if: |
      always() && 
      (needs.ci.result == 'success' || needs.ci.result == 'skipped')
    timeout-minutes: 30
    environment:
      name: dev
      url: ${{ steps.deploy.outputs.webapp-url }}

    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME || 'dev' }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION || 'eastus2' }}
      DEPLOYER_PRINCIPAL_TYPE: ${{ vars.DEPLOYER_PRINCIPAL_TYPE || 'ServicePrincipal' }}
      DEPLOY_HEALTH_MODEL: ${{ vars.DEPLOY_HEALTH_MODEL }}

    outputs:
      webapp-url: ${{ steps.deploy.outputs.webapp-url }}
      resource-group: ${{ steps.deploy.outputs.resource-group }}

    steps:
      # ------------------------------------------------------------------------
      # Phase 1: Setup
      # Install prerequisites including go-sqlcmd for SQL Managed Identity config
      # ------------------------------------------------------------------------
      - name: üì• Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: üì¶ Install Prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dos2unix software-properties-common

          # Remove any existing ODBC sqlcmd (mssql-tools) to prevent PATH conflicts
          # The ODBC version doesn't support Azure AD authentication
          echo "Checking for existing ODBC sqlcmd installations..."
          if [ -f /opt/mssql-tools/bin/sqlcmd ]; then
            echo "Removing ODBC sqlcmd from /opt/mssql-tools/bin..."
            sudo rm -f /opt/mssql-tools/bin/sqlcmd
          fi
          if [ -f /opt/mssql-tools18/bin/sqlcmd ]; then
            echo "Removing ODBC sqlcmd from /opt/mssql-tools18/bin..."
            sudo rm -f /opt/mssql-tools18/bin/sqlcmd
          fi

          # Install go-sqlcmd (modern sqlcmd with Azure AD authentication support)
          # Reference: https://github.com/microsoft/go-sqlcmd
          # Note: go-sqlcmd is required for --authentication-method ActiveDirectoryAzCli
          echo "Installing go-sqlcmd..."

          # Fetch latest version with retry logic for API reliability
          for i in 1 2 3; do
            SQLCMD_VERSION=$(curl -sS --retry 3 --retry-delay 2 https://api.github.com/repos/microsoft/go-sqlcmd/releases/latest | jq -r '.tag_name')
            if [ -n "$SQLCMD_VERSION" ] && [ "$SQLCMD_VERSION" != "null" ]; then
              break
            fi
            echo "Retry $i: Failed to fetch version, waiting..."
            sleep 5
          done

          if [ -z "$SQLCMD_VERSION" ] || [ "$SQLCMD_VERSION" == "null" ]; then
            echo "::error::Failed to fetch go-sqlcmd version from GitHub API"
            exit 1
          fi
          echo "Latest go-sqlcmd version: $SQLCMD_VERSION"

          # Download and extract go-sqlcmd for Linux amd64
          curl -sSL "https://github.com/microsoft/go-sqlcmd/releases/download/${SQLCMD_VERSION}/sqlcmd-linux-amd64.tar.bz2" -o sqlcmd.tar.bz2
          tar -xjf sqlcmd.tar.bz2
          sudo mv sqlcmd /usr/local/bin/sqlcmd
          sudo chmod +x /usr/local/bin/sqlcmd
          rm -f sqlcmd.tar.bz2

          # Verify go-sqlcmd is installed and is the correct version
          echo "Verifying sqlcmd installation..."
          which sqlcmd
          echo "sqlcmd path: $(which sqlcmd)"
          sqlcmd --version

          # Double-check it's go-sqlcmd (not ODBC)
          if ! sqlcmd --version 2>&1 | grep -qi "go-sqlcmd\|Version:"; then
            echo "ERROR: sqlcmd does not appear to be go-sqlcmd!"
            exit 1
          fi
          echo "‚úì go-sqlcmd installed successfully"

      - name: üîß Install Azure Developer CLI
        uses: Azure/setup-azd@c495e71ba59e44bfaaac10a32c8ee90d191ca4a3 # v2.2.1
        with:
          version: "latest"

      - name: üîß Setup .NET SDK
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ------------------------------------------------------------------------
      # Phase 2: Authentication
      # Authenticate both azd CLI and Azure CLI using OIDC federated credentials
      # ------------------------------------------------------------------------
      - name: üîê Log in with Azure (Federated Credentials)
        run: |
          echo "::group::üîê Authenticating with Azure"
          echo "‚Üí Client ID: $AZURE_CLIENT_ID"
          echo "‚Üí Tenant ID: $AZURE_TENANT_ID"
          echo "‚Üí Method: Federated Credentials (OIDC)"
          echo ""
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"
          echo "::endgroup::"
          echo "::notice title=Azure Auth::‚úÖ Successfully authenticated with Azure"

      - name: üîë Logging in to Azure CLI
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.4.0
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
          args: --timeout 900

      # ------------------------------------------------------------------------
      # Phase 3: Provision Infrastructure
      # Provisions Azure resources using azd provision (runs Bicep templates)
      # Includes retry logic for transient Azure API failures
      # ------------------------------------------------------------------------
      - name: üèóÔ∏è Provision Infrastructure
        id: provision
        run: |
          echo "::group::üèóÔ∏è Provisioning Azure infrastructure"
          echo "‚Üí Environment: $AZURE_ENV_NAME"
          echo "‚Üí Location: $AZURE_LOCATION"
          echo "‚Üí Subscription: $AZURE_SUBSCRIPTION_ID"
          echo ""

          # Retry logic for transient Azure API failures
          MAX_RETRIES=3
          RETRY_DELAY=30

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Provisioning attempt $attempt of $MAX_RETRIES..."
            if azd provision --no-prompt 2>&1 | tee /tmp/provision.log; then
              echo "::endgroup::"
              echo "::notice title=Provision::‚úÖ Infrastructure provisioned successfully"
              break
            else
              if [ $attempt -eq $MAX_RETRIES ]; then
                echo "::endgroup::"
                echo "::error title=Provision::‚ùå Infrastructure provisioning failed after $MAX_RETRIES attempts"
                cat /tmp/provision.log
                exit 1
              fi
              echo "::warning::Provisioning attempt $attempt failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          # Show postprovision hook output
          echo ""
          echo "=== Checking if postprovision ran ==="
          grep -i "postprovision\|sql\|managed identity\|database" /tmp/provision.log || echo "No postprovision output found"

      # ------------------------------------------------------------------------
      # Phase 4: SQL Managed Identity Configuration
      # Creates database user for the managed identity using go-sqlcmd.
      # Uses SID-based user creation to bypass MS Graph API lookup.
      # ------------------------------------------------------------------------
      - name: üîë Create SQL User with Client ID
        run: |
          echo "::group::üîë Creating SQL database user using Client ID (Application ID)"

          # Get values from azd environment
          SQL_SERVER=$(azd env get-values | grep "AZURE_SQL_SERVER_NAME" | cut -d'=' -f2 | tr -d '"')
          SQL_DB=$(azd env get-values | grep "AZURE_SQL_DATABASE_NAME" | cut -d'=' -f2 | tr -d '"')
          MI_NAME=$(azd env get-values | grep "MANAGED_IDENTITY_NAME" | cut -d'=' -f2 | tr -d '"')
          MI_CLIENT_ID=$(azd env get-values | grep "MANAGED_IDENTITY_CLIENT_ID" | cut -d'=' -f2 | tr -d '"')
          RG="rg-orders-${AZURE_ENV_NAME}-${AZURE_LOCATION}"

          echo "SQL Server: $SQL_SERVER"
          echo "Database: $SQL_DB"
          echo "Managed Identity Name: $MI_NAME"
          echo "Managed Identity Client ID: $MI_CLIENT_ID"

          # IMPORTANT: For Azure SQL Database with Entra ID (Azure AD) authentication,
          # the SID must be created from the CLIENT ID (Application ID), NOT the Object ID.
          # The Client ID is used as the identity claim in the access token.
          # Reference: https://learn.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-service-principal

          # Verify we have the client ID
          if [ -z "$MI_CLIENT_ID" ]; then
            echo "::error::Managed Identity Client ID not found in environment variables"
            echo "Attempting to fetch from Azure..."
            MI_CLIENT_ID=$(az identity show --name "$MI_NAME" --resource-group "$RG" --query clientId -o tsv)
          fi
          echo "Using Client ID for SID: $MI_CLIENT_ID"

          # Create SQL script that uses SID derived from CLIENT ID
          # This bypasses the MS Graph lookup requirement
          # Note: Writing to a temp file instead of piping to avoid go-sqlcmd stdin crash
          SQL_SCRIPT_FILE=$(mktemp --suffix=.sql)
          cat > "$SQL_SCRIPT_FILE" << 'EOSQL'
          -- Calculate the expected SID from Client ID
          DECLARE @expectedSid VARBINARY(16);
          SET @expectedSid = CAST(CAST('$(MI_CLIENT_ID)' AS UNIQUEIDENTIFIER) AS VARBINARY(16));

          -- Check if user already exists
          IF EXISTS (SELECT 1 FROM sys.database_principals WHERE name = N'$(MI_NAME)')
          BEGIN
              -- User exists - verify the SID matches the expected Client ID
              DECLARE @existingSid VARBINARY(85);
              SELECT @existingSid = sid FROM sys.database_principals WHERE name = N'$(MI_NAME)';
              
              IF @existingSid <> @expectedSid
              BEGIN
                  -- SID mismatch - user was likely created with wrong ID (Object ID instead of Client ID)
                  -- Drop and recreate with correct SID
                  PRINT 'WARNING: User [$(MI_NAME)] exists but SID does not match Client ID.';
                  PRINT 'Expected SID (from Client ID): ' + CONVERT(VARCHAR(64), @expectedSid, 2);
                  PRINT 'Actual SID: ' + CONVERT(VARCHAR(64), @existingSid, 2);
                  PRINT 'Dropping and recreating user with correct SID...';
                  
                  DROP USER [$(MI_NAME)];
                  PRINT 'INFO: Dropped user [$(MI_NAME)]';
                  
                  -- Recreate with correct SID
                  DECLARE @createSql NVARCHAR(MAX);
                  SET @createSql = N'CREATE USER [$(MI_NAME)] WITH SID = 0x' + 
                               CONVERT(VARCHAR(64), @expectedSid, 2) + 
                               N', TYPE = E';
                  EXEC sp_executesql @createSql;
                  PRINT 'SUCCESS: User [$(MI_NAME)] recreated with correct SID from Client ID';
              END
              ELSE
              BEGIN
                  PRINT 'INFO: User [$(MI_NAME)] already exists with correct SID';
              END
          END
          ELSE
          BEGIN
              -- User doesn't exist - create with correct SID
              DECLARE @sql NVARCHAR(MAX);
              SET @sql = N'CREATE USER [$(MI_NAME)] WITH SID = 0x' + 
                         CONVERT(VARCHAR(64), @expectedSid, 2) + 
                         N', TYPE = E';
              EXEC sp_executesql @sql;
              PRINT 'SUCCESS: User [$(MI_NAME)] created with SID from Client ID';
          END;

          -- Add to db_owner role
          IF NOT EXISTS (SELECT 1 FROM sys.database_role_members rm 
                         JOIN sys.database_principals r ON rm.role_principal_id = r.principal_id 
                         JOIN sys.database_principals m ON rm.member_principal_id = m.principal_id 
                         WHERE r.name = 'db_owner' AND m.name = '$(MI_NAME)')
          BEGIN
              ALTER ROLE [db_owner] ADD MEMBER [$(MI_NAME)];
              PRINT 'SUCCESS: Added [$(MI_NAME)] to db_owner role';
          END
          ELSE
          BEGIN
              PRINT 'INFO: [$(MI_NAME)] is already in db_owner role';
          END;
          EOSQL

          echo "SQL script written to: $SQL_SCRIPT_FILE"
          echo "Script contents:"
          cat "$SQL_SCRIPT_FILE"

          echo ""
          echo "Executing SQL script with retry logic..."

          # Retry logic for transient SQL connectivity issues
          MAX_RETRIES=3
          RETRY_DELAY=15

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "SQL execution attempt $attempt of $MAX_RETRIES..."
            if sqlcmd -S "${SQL_SERVER}.database.windows.net" -d "$SQL_DB" \
              --authentication-method ActiveDirectoryAzCli -N true \
              -v MI_NAME="$MI_NAME" MI_CLIENT_ID="$MI_CLIENT_ID" \
              -i "$SQL_SCRIPT_FILE"; then
              echo "‚úì SQL script executed successfully"
              break
            else
              if [ $attempt -eq $MAX_RETRIES ]; then
                echo "::error::SQL script execution failed after $MAX_RETRIES attempts"
                rm -f "$SQL_SCRIPT_FILE"
                exit 1
              fi
              echo "::warning::SQL execution attempt $attempt failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          # Cleanup temp file
          rm -f "$SQL_SCRIPT_FILE"

          echo ""
          echo "Verifying user creation..."
          sqlcmd -S "${SQL_SERVER}.database.windows.net" -d "$SQL_DB" --authentication-method ActiveDirectoryAzCli -N true \
            -Q "SELECT name, type_desc, authentication_type_desc, CONVERT(VARCHAR(64), sid, 2) as sid_hex FROM sys.database_principals WHERE name = '$MI_NAME'"

          echo "::endgroup::"

      # ------------------------------------------------------------------------
      # Phase 5: Re-authentication
      # Re-authenticate after SQL operations to refresh OIDC tokens.
      # Required because tokens may expire during long-running SQL operations.
      # ------------------------------------------------------------------------
      - name: üîê Log in with Azure (Federated Credentials)
        run: |
          echo "::group::üîê Authenticating with Azure"
          echo "‚Üí Client ID: $AZURE_CLIENT_ID"
          echo "‚Üí Tenant ID: $AZURE_TENANT_ID"
          echo "‚Üí Method: Federated Credentials (OIDC)"
          echo ""
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"
          echo "::endgroup::"
          echo "::notice title=Azure Auth::‚úÖ Successfully authenticated with Azure"

      - name: üîë Logging in to Azure CLI
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.4.0
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
          args: --timeout 900

      # ------------------------------------------------------------------------
      # Phase 6: Deploy Application
      # Deploys application code using azd deploy command
      # Includes retry logic for transient deployment failures
      # ------------------------------------------------------------------------
      - name: üöÄ Deploy Application
        id: deploy
        run: |
          echo "::group::üöÄ Deploying application to Azure"
          echo "‚Üí Environment: $AZURE_ENV_NAME"
          echo "‚Üí Configuration: Release"
          echo ""

          # Retry logic for transient deployment failures
          MAX_RETRIES=3
          RETRY_DELAY=30

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Deployment attempt $attempt of $MAX_RETRIES..."
            if azd deploy --no-prompt; then
              echo "::endgroup::"
              echo "::notice title=Deploy::‚úÖ Application deployed successfully"
              break
            else
              if [ $attempt -eq $MAX_RETRIES ]; then
                echo "::endgroup::"
                echo "::error title=Deploy::‚ùå Application deployment failed after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "::warning::Deployment attempt $attempt failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          # Extract outputs for summary
          RESOURCE_GROUP="${AZURE_ENV_NAME}-rg"
          AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN="${AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN}"
          echo "resource-group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "webapp-url=https://aspire-dashboard.ext.$AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------------
      # Phase 7: Summary
      # Generate deployment summary with status, environment info, and rollback instructions
      # ------------------------------------------------------------------------
      - name: üìä Generate deployment summary
        if: always()
        run: |
          echo "## üöÄ Dev Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status badge
          if [ "${{ job.status }}" == "success" ]; then
            echo "![Deployment Status](https://img.shields.io/badge/deployment-successful-brightgreen?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          else
            echo "![Deployment Status](https://img.shields.io/badge/deployment-failed-red?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Environment info
          echo "### üéØ Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | $( [ '${{ job.status }}' == 'success' ] && echo '‚úÖ Deployed' || echo '‚ùå Failed' ) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Environment** | \`$AZURE_ENV_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Location** | \`$AZURE_LOCATION\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Git info (collapsible)
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üìã Deployment Details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | [\`${{ github.ref_name }}\`](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | [@${{ github.actor }}](${{ github.server_url }}/${{ github.actor }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show rollback on failure
          if [ "${{ job.status }}" != "success" ]; then
            echo "### ‚ö†Ô∏è Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üîÑ Rollback Instructions</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To rollback to a previous deployment:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Option 1: Re-run with previous commit" >> $GITHUB_STEP_SUMMARY
            echo "gh workflow run azure-dev.yml --ref <previous-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Option 2: Use Azure Developer CLI locally" >> $GITHUB_STEP_SUMMARY
            echo "git checkout <previous-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "azd deploy --no-prompt" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application has been deployed to the \`dev\` environment." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Workflow Summary Job
  # ============================================================================
  # Generates a comprehensive workflow summary with:
  # - Overall pipeline status (CI + Deploy)
  # - Individual job results
  # - Workflow details and links
  # - Action required guidance on failure
  # Always runs regardless of previous job outcomes.
  # ============================================================================
  summary:
    name: üìä Summary
    runs-on: ubuntu-latest
    needs: [ci, deploy-dev]
    if: always()
    timeout-minutes: 5

    steps:
      - name: üìä Generate workflow summary
        run: |
          echo "# üöÄ CD Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status determination
          if ([ "${{ needs.ci.result }}" == "success" ] || [ "${{ needs.ci.result }}" == "skipped" ]) && \
             [ "${{ needs.deploy-dev.result }}" == "success" ]; then
            echo "![CD Status](https://img.shields.io/badge/CD-successful-brightgreen?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          else
            echo "![CD Status](https://img.shields.io/badge/CD-failed-red?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìã Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|-------------|" >> $GITHUB_STEP_SUMMARY

          # CI status
          CI_RESULT="${{ needs.ci.result }}"
          if [ "$CI_RESULT" == "success" ]; then
            echo "| üî® CI Pipeline | ‚úÖ Passed | Build, test, and analysis completed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$CI_RESULT" == "skipped" ]; then
            echo "| üî® CI Pipeline | ‚è≠Ô∏è Skipped | CI checks bypassed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üî® CI Pipeline | ‚ùå Failed | CI checks failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Dev deployment status
          DEV_RESULT="${{ needs.deploy-dev.result }}"
          if [ "$DEV_RESULT" == "success" ]; then
            echo "| üöÄ Deploy Dev | ‚úÖ Deployed | Application deployed to dev environment |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DEV_RESULT" == "skipped" ]; then
            echo "| üöÄ Deploy Dev | ‚è≠Ô∏è Skipped | Deployment skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üöÄ Deploy Dev | ‚ùå Failed | Deployment failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Workflow details (collapsible)
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üìù Workflow Details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | [\`${{ github.ref_name }}\`](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | [@${{ github.actor }}](${{ github.server_url }}/${{ github.actor }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Action required on failure
          if [ "${{ needs.deploy-dev.result }}" != "success" ] && [ "${{ needs.deploy-dev.result }}" != "skipped" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ö†Ô∏è Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment pipeline has failed. Please review the logs and take corrective action." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Quick Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "- üîÑ [Re-run workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "- üìñ Check the deployment logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
            echo "- üí¨ Review Azure portal for resource status" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Failure Handler Job
  # ============================================================================
  # Provides visual failure indication in the workflow graph and generates
  # a failure report with job statuses and next steps for troubleshooting.
  # Only runs when CI or deploy-dev jobs fail.
  # ============================================================================
  on-failure:
    name: ‚ùå Handle Failure
    runs-on: ubuntu-latest
    needs: [ci, deploy-dev]
    if: failure()
    timeout-minutes: 5

    steps:
      - name: ‚ùå Report failure
        run: |
          echo "::error title=Pipeline Failed::One or more jobs failed. Review the logs above."

          echo "## ‚ùå Pipeline Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîÑ CI | ${{ needs.ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ Deploy Dev | ${{ needs.deploy-dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Click on the failed job above to see detailed logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix the issue in your code" >> $GITHUB_STEP_SUMMARY
          echo "3. Push a new commit or re-run the workflow" >> $GITHUB_STEP_SUMMARY

# ============================================================================
# .NET Continuous Integration Workflow
# ============================================================================
#
# Purpose:
#   Builds, tests, and analyzes the .NET solution to ensure code quality
#   and prevent regressions on every push and pull request.
#
# Features:
#   - Dependency caching for faster builds
#   - Code coverage collection and reporting
#   - Static code analysis with dotnet format
#   - Test result publishing with detailed summaries
#   - Build artifact upload for debugging
#
# Triggers:
#   - Push to main branch (with path filters)
#   - Pull requests targeting main branch
#   - Manual workflow dispatch for ad-hoc runs
#
# Documentation:
#   https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
#
# ============================================================================

name: CI - .NET Build and Test

# ------------------------------------------------------------------------------
# Trigger Configuration
# ------------------------------------------------------------------------------
on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "app.*/**"
      - "*.sln"
      - "global.json"
      - ".github/workflows/ci-dotnet.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "app.*/**"
      - "*.sln"
      - "global.json"
      - ".github/workflows/ci-dotnet.yml"
  workflow_dispatch:
    inputs:
      configuration:
        description: "Build configuration"
        required: false
        default: "Release"
        type: choice
        options:
          - Release
          - Debug

# ------------------------------------------------------------------------------
# Concurrency Configuration
# Prevents duplicate workflow runs for the same branch/PR
# ------------------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------------------------
# Workflow-level Permissions (Least Privilege)
# ------------------------------------------------------------------------------
permissions:
  contents: read
  checks: write
  pull-requests: write

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------
env:
  DOTNET_VERSION: "10.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}
  SOLUTION_FILE: "app.sln"

jobs:
  # ============================================================================
  # Build Job
  # ============================================================================
  # Purpose: Restore dependencies, build the solution, and create artifacts
  # ============================================================================
  build:
    name: ðŸ”¨ Build
    runs-on: ubuntu-latest
    outputs:
      build-version: ${{ steps.version.outputs.version }}

    steps:
      # ------------------------------------------------------------------------
      # Checkout Repository
      # ------------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Full history for versioning

      # ------------------------------------------------------------------------
      # Setup .NET SDK
      # Uses version from environment variable for consistency
      # ------------------------------------------------------------------------
      - name: ðŸ”§ Setup .NET SDK
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: "**/*.csproj"

      # ------------------------------------------------------------------------
      # Generate Build Version
      # Creates a semantic version based on git history
      # ------------------------------------------------------------------------
      - name: ðŸ·ï¸ Generate build version
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "::notice title=Build Version::$VERSION"

      # ------------------------------------------------------------------------
      # Cache NuGet Packages
      # Significantly speeds up restore operations
      # ------------------------------------------------------------------------
      - name: ðŸ“¦ Cache NuGet packages
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # ------------------------------------------------------------------------
      # Restore Dependencies
      # ------------------------------------------------------------------------
      - name: ðŸ“¥ Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }} --verbosity minimal

      # ------------------------------------------------------------------------
      # Build Solution
      # ------------------------------------------------------------------------
      - name: ðŸ”¨ Build solution
        run: |
          dotnet build ${{ env.SOLUTION_FILE }} \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            /p:Version=${{ steps.version.outputs.version }} \
            /p:ContinuousIntegrationBuild=true

      # ------------------------------------------------------------------------
      # Upload Build Artifacts
      # Preserves build output for downstream jobs and debugging
      # ------------------------------------------------------------------------
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: build-artifacts
          path: |
            **/bin/${{ env.CONFIGURATION }}/**
            !**/bin/${{ env.CONFIGURATION }}/**/ref/**
          retention-days: 7
          if-no-files-found: error

      # ------------------------------------------------------------------------
      # Build Summary
      # ------------------------------------------------------------------------
      - name: ðŸ“Š Generate build summary
        run: |
          echo "## ðŸ”¨ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration** | \`${{ env.CONFIGURATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Runner** | \`${{ runner.os }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **.NET Version** | \`${{ env.DOTNET_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Test Job
  # ============================================================================
  # Purpose: Run unit tests with code coverage collection
  # Dependencies: Requires build job to complete successfully
  # ============================================================================
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      # ------------------------------------------------------------------------
      # Checkout Repository
      # ------------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # ------------------------------------------------------------------------
      # Setup .NET SDK
      # ------------------------------------------------------------------------
      - name: ðŸ”§ Setup .NET SDK
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: "**/*.csproj"

      # ------------------------------------------------------------------------
      # Cache NuGet Packages
      # ------------------------------------------------------------------------
      - name: ðŸ“¦ Cache NuGet packages
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # ------------------------------------------------------------------------
      # Restore Dependencies
      # ------------------------------------------------------------------------
      - name: ðŸ“¥ Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }} --verbosity minimal

      # ------------------------------------------------------------------------
      # Run Tests with Coverage
      # Collects code coverage using Coverlet
      # ------------------------------------------------------------------------
      - name: ðŸ§ª Run tests with coverage
        run: |
          dotnet test ${{ env.SOLUTION_FILE }} \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore \
            --verbosity normal \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=detailed" \
            --results-directory "${{ github.workspace }}/TestResults" \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      # ------------------------------------------------------------------------
      # Publish Test Results
      # Creates a check run with test results visible in PR
      # ------------------------------------------------------------------------
      - name: ðŸ“‹ Publish test results
        uses: dorny/test-reporter@890f7f1a633a6f5cc23afa81ddf7bd50dc22a37d # v2.0.0
        if: always()
        with:
          name: "Test Results"
          path: "${{ github.workspace }}/TestResults/**/*.trx"
          reporter: dotnet-trx
          fail-on-error: true

      # ------------------------------------------------------------------------
      # Upload Test Results Artifact
      # ------------------------------------------------------------------------
      - name: ðŸ“¤ Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: test-results
          path: ${{ github.workspace }}/TestResults
          retention-days: 30

      # ------------------------------------------------------------------------
      # Upload Code Coverage
      # ------------------------------------------------------------------------
      - name: ðŸ“¤ Upload code coverage
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: code-coverage
          path: ${{ github.workspace }}/TestResults/**/coverage.cobertura.xml
          retention-days: 30

      # ------------------------------------------------------------------------
      # Test Summary
      # ------------------------------------------------------------------------
      - name: ðŸ“Š Generate test summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration** | \`${{ env.CONFIGURATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Test Framework** | Microsoft.Testing.Platform |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Test results and code coverage reports are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Code Analysis Job
  # ============================================================================
  # Purpose: Static code analysis and format verification
  # Dependencies: Runs in parallel with test job
  # ============================================================================
  analyze:
    name: ðŸ” Analyze
    runs-on: ubuntu-latest
    needs: build

    steps:
      # ------------------------------------------------------------------------
      # Checkout Repository
      # ------------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # ------------------------------------------------------------------------
      # Setup .NET SDK
      # ------------------------------------------------------------------------
      - name: ðŸ”§ Setup .NET SDK
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: "**/*.csproj"

      # ------------------------------------------------------------------------
      # Cache NuGet Packages
      # ------------------------------------------------------------------------
      - name: ðŸ“¦ Cache NuGet packages
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # ------------------------------------------------------------------------
      # Restore Dependencies
      # ------------------------------------------------------------------------
      - name: ðŸ“¥ Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }} --verbosity minimal

      # ------------------------------------------------------------------------
      # Verify Code Formatting
      # Ensures code follows project formatting standards
      # ------------------------------------------------------------------------
      - name: ðŸŽ¨ Verify code formatting
        id: format-check
        run: |
          echo "::group::Checking code format"
          dotnet format ${{ env.SOLUTION_FILE }} --verify-no-changes --verbosity diagnostic || {
            echo "::error title=Code Formatting::Code formatting issues detected. Run 'dotnet format' locally to fix."
            exit 1
          }
          echo "::endgroup::"
        continue-on-error: true

      # ------------------------------------------------------------------------
      # Analysis Summary
      # ------------------------------------------------------------------------
      - name: ðŸ“Š Generate analysis summary
        if: always()
        run: |
          echo "## ðŸ” Code Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.format-check.outcome }}" == "success" ]; then
            echo "âœ… **Code Formatting**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Formatting**: Failed - Run \`dotnet format\` locally to fix" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`dotnet format\` before committing to auto-fix formatting issues" >> $GITHUB_STEP_SUMMARY
          echo "- Consider adding a pre-commit hook for automatic formatting" >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------------------------
      # Fail if format check failed
      # ------------------------------------------------------------------------
      - name: âŒ Fail on format issues
        if: steps.format-check.outcome == 'failure'
        run: exit 1

  # ============================================================================
  # Workflow Summary Job
  # ============================================================================
  # Purpose: Generate final workflow summary after all jobs complete
  # Dependencies: Requires all other jobs to complete
  # ============================================================================
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [build, test, analyze]
    if: always()

    steps:
      # ------------------------------------------------------------------------
      # Generate Final Summary
      # ------------------------------------------------------------------------
      - name: ðŸ“Š Generate workflow summary
        run: |
          echo "# ðŸš€ CI Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Build status
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| ðŸ”¨ Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”¨ Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Test status
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| ðŸ§ª Test | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª Test | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze status
          if [ "${{ needs.analyze.result }}" == "success" ]; then
            echo "| ðŸ” Analyze | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” Analyze | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ github.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run Number** | \`${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following artifacts are available for download:" >> $GITHUB_STEP_SUMMARY
          echo "- **build-artifacts** - Compiled binaries" >> $GITHUB_STEP_SUMMARY
          echo "- **test-results** - Test execution results (.trx files)" >> $GITHUB_STEP_SUMMARY
          echo "- **code-coverage** - Code coverage reports (Cobertura format)" >> $GITHUB_STEP_SUMMARY

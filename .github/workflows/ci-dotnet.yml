# ============================================================================
# .NET Continuous Integration Workflow
# ============================================================================
#
# Purpose:
#   Orchestrates the CI pipeline by calling the reusable workflow.
#   Handles triggers, path filters, and passes configuration to the
#   reusable workflow.
#
# Features:
#   - Cross-platform builds (Ubuntu, Windows, macOS)
#   - Cross-platform testing with code coverage (Cobertura)
#   - Code formatting analysis (.editorconfig compliance)
#   - CodeQL security vulnerability scanning (always enabled)
#   - Test result publishing with detailed summaries
#   - Build artifacts upload per platform
#
# Jobs Executed (via reusable workflow):
#   1. Build     - Compiles solution on all platforms
#   2. Test      - Runs tests with coverage on all platforms
#   3. Analyze   - Verifies code formatting (optional)
#   4. CodeQL    - Security vulnerability scanning (always runs)
#   5. Summary   - Aggregates results from all jobs
#
# Triggers:
#   - Push to main and feature branches (with path filters)
#   - Pull requests targeting main branch
#   - Manual workflow dispatch for ad-hoc runs
#
# Prerequisites:
#   - The reusable workflow file must exist at:
#     .github/workflows/ci-dotnet-reusable.yml
#   - This workflow must be on the default branch (main) or the same branch
#     for the reusable workflow reference to resolve correctly.
#
# Documentation:
#   https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
#   https://docs.github.com/en/actions/using-workflows/reusing-workflows
#
# ============================================================================

name: CI - .NET Build and Test

# ------------------------------------------------------------------------------
# Trigger Configuration
# ------------------------------------------------------------------------------
on:
  push:
    branches:
      - "main"
      - "feature/**"
      - "bugfix/**"
      - "hotfix/**"
      - "release/**"
      - "chore/**"
      - "docs/**"
      - "refactor/**"
      - "test/**"
    paths:
      - "src/**"
      - "app.*/**"
      - "*.sln"
      - "global.json"
      - ".github/workflows/ci-dotnet.yml"
      - ".github/workflows/ci-dotnet-reusable.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "app.*/**"
      - "*.sln"
      - "global.json"
      - ".github/workflows/ci-dotnet.yml"
      - ".github/workflows/ci-dotnet-reusable.yml"
  workflow_dispatch:
    inputs:
      configuration:
        description: "Build configuration"
        required: false
        default: "Release"
        type: choice
        options:
          - Release
          - Debug
      enable-code-analysis:
        description: "Enable code formatting analysis"
        required: false
        default: true
        type: boolean

# ------------------------------------------------------------------------------
# Concurrency Configuration
# Prevents duplicate workflow runs for the same branch/PR
# ------------------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------------------------
# Workflow-level Permissions (Least Privilege)
# - contents: read        - Read repository contents for checkout
# - checks: write         - Create check runs for test results
# - pull-requests: write  - Post comments on pull requests
# - security-events: write - Upload CodeQL SARIF results to Security tab
# ------------------------------------------------------------------------------
permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write

jobs:
  # ============================================================================
  # Call Reusable CI Workflow
  # ============================================================================
  # Executes the comprehensive CI pipeline:
  # - Build and Test run on all platforms via matrix (Ubuntu, Windows, macOS)
  # - Analyze job verifies code formatting (optional, runs on runs-on runner)
  # - CodeQL job performs security scanning (always runs on runs-on runner)
  # - Summary job aggregates all results
  # ============================================================================
  ci:
    name: ðŸš€ CI
    uses: ./.github/workflows/ci-dotnet-reusable.yml
    with:
      configuration: ${{ inputs.configuration || 'Release' }}
      dotnet-version: "10.0.x"
      solution-file: "app.sln"
      test-results-artifact-name: "test-results"
      build-artifacts-name: "build-artifacts"
      coverage-artifact-name: "code-coverage"
      artifact-retention-days: 30
      runs-on: "ubuntu-latest" # Used for Analyze, CodeQL, and Summary jobs (Build/Test use cross-platform matrix)
      enable-code-analysis: ${{ inputs.enable-code-analysis == '' && true || inputs.enable-code-analysis }}
      fail-on-format-issues: true
    secrets: inherit

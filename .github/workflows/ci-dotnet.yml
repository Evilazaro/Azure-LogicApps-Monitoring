# ============================================================================
# .NET Continuous Integration Workflow
# ============================================================================
#
# Purpose:
#   Orchestrates the CI pipeline by calling the reusable workflow.
#   Handles triggers, path filters, and passes configuration to the
#   reusable workflow.
#
# Features:
#   - Cross-platform builds and tests (Ubuntu, Windows, macOS)
#   - Code coverage collection and reporting
#   - Static code analysis with dotnet format
#   - Test result publishing with detailed summaries
#   - Build artifact upload for debugging (per-platform)
#
# Triggers:
#   - Push to main and feature branches (with path filters)
#   - Pull requests targeting main branch
#   - Manual workflow dispatch for ad-hoc runs
#
# Documentation:
#   https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
#
# ============================================================================

name: CI - .NET Build and Test

# ------------------------------------------------------------------------------
# Trigger Configuration
# ------------------------------------------------------------------------------
on:
  push:
    branches:
      - "main"
      - "feature/**"
      - "bugfix/**"
      - "hotfix/**"
      - "release/**"
      - "chore/**"
      - "docs/**"
      - "refactor/**"
      - "test/**"
    paths:
      - "src/**"
      - "app.*/**"
      - "*.sln"
      - "global.json"
      - ".github/workflows/ci-dotnet.yml"
      - ".github/workflows/ci-dotnet-reusable.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "app.*/**"
      - "*.sln"
      - "global.json"
      - ".github/workflows/ci-dotnet.yml"
      - ".github/workflows/ci-dotnet-reusable.yml"
  workflow_dispatch:
    inputs:
      configuration:
        description: "Build configuration"
        required: false
        default: "Release"
        type: choice
        options:
          - Release
          - Debug
      enable-code-analysis:
        description: "Enable code formatting analysis"
        required: false
        default: true
        type: boolean

# ------------------------------------------------------------------------------
# Concurrency Configuration
# Prevents duplicate workflow runs for the same branch/PR
# ------------------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------------------------
# Workflow-level Permissions (Least Privilege)
# ------------------------------------------------------------------------------
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ============================================================================
  # Call Reusable CI Workflow
  # Note: Build and test jobs always run on all platforms (Ubuntu, Windows, macOS)
  # via matrix strategy in the reusable workflow.
  # ============================================================================
  ci:
    name: ðŸš€ CI
    uses: ./.github/workflows/ci-dotnet-reusable.yml
    with:
      configuration: ${{ inputs.configuration || 'Release' }}
      dotnet-version: "10.0.x"
      solution-file: "app.sln"
      test-results-artifact-name: "test-results"
      build-artifacts-name: "build-artifacts"
      coverage-artifact-name: "code-coverage"
      artifact-retention-days: 30
      runs-on: "ubuntu-latest" # Used for analyze and summary jobs only (build/test use cross-platform matrix)
      enable-code-analysis: ${{ inputs.enable-code-analysis == '' && true || inputs.enable-code-analysis }}
      fail-on-format-issues: true
    secrets: inherit
